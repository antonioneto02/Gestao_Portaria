<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="/js/back-to-top.js"></script>
<script src="/js/sessionTimeout.js"></script>
<script src="/assets/app.js"></script>


<script>
(function(){
  if (!$.fn || !$.fn.dataTable) return;
  
  try {
    if ($.fn.dataTable.ext && $.fn.dataTable.ext.buttons && $.fn.dataTable.ext.buttons.excelHtml5) {
      var excelBtn = $.fn.dataTable.ext.buttons.excelHtml5;
      excelBtn.exportOptions = $.extend(true, { columns: ':visible' }, excelBtn.exportOptions || {});
    }
  } catch(_){ }
  $.fn.dataTable.ext.type.detect.unshift(function (d) {
    if (typeof d !== 'string') return null;
    d = d.trim();
    var re = /^\d{1,2}\/\d{1,2}\/\d{2,4}$/;
    return re.test(d) ? 'date-eu' : null;
  });

  $.fn.dataTable.ext.type.detect.unshift(function (d) {
    if (typeof d !== 'string') return null;
    var s = d.trim();
    if (s === '') return null;
    var numLike = /(?:R\$\s*)?[\-]?\d{1,3}(?:[\.\s]\d{3})*(?:,\d+)?(?:\s*(?:kg|km))?$/i;
    return numLike.test(s) ? 'num-br' : null;
  });

  $.fn.dataTable.ext.type.order['num-br-pre'] = function (d) {
    if (d === null || d === undefined) return 0;
    var s = String(d).trim();
    if (s === '') return 0;
    s = s.replace(/R\$\s*/g, '').replace(/\s*(?:kg|km)\s*$/i, '');
    s = s.replace(/\./g, '').replace(/\s/g, '').replace(/,/g, '.');
    var n = parseFloat(s.replace(/[^0-9\-\.]/g, ''));
    return isNaN(n) ? 0 : n;
  };

  $.fn.dataTable.ext.type.order['date-eu-pre'] = function (d) {
    if (!d || typeof d !== 'string') return 0;
    var p = d.split('/');
    if (p.length !== 3) return 0;
    var dd = ('0' + parseInt(p[0],10)).slice(-2);
    var mm = ('0' + parseInt(p[1],10)).slice(-2);
    var yy = p[2].length === 2 ? ('20' + p[2]) : p[2];
    return parseInt(yy + mm + dd, 10);
  };

  function applyBaseCellStyles($table) {
    try {
      if (!$table || !$table.length) return;
      var $cells = $table.find('td, th');
      if (!$cells.length) return;
      $cells.css({
        'max-width': '200px',
        'white-space': 'nowrap',
        'overflow': 'hidden',
        'text-overflow': 'ellipsis',
        'padding': '2px',
        'font-size': '12px'
      });
    } catch(_) { }
  }

  $(document).on('init.dt', function (e, settings) {
    try { 
      applyBaseCellStyles($(settings.nTable));
    } catch(_) {}
  });
  $(document).on('draw.dt', function (e, settings) {
    try { 
      applyBaseCellStyles($(settings.nTable));
    } catch(_) {}
  });

  $(document).on('init.dt', function (e, settings) {
    try {
      var api = new $.fn.dataTable.Api(settings);
      var tableNode = api.table().node();
      var $ths = $(tableNode).find('thead th');
      var prioridades = [
        ['DT BAIXA','Dt Baixa','dt baixa'],
        ['DT PROC','Dt Proc','dt proc','DT PROCESSAMENTO'],
        ['DT EMIS','Dt Emis','dt emis','DT EMISSÃO','Dt Emissão'],
        ['DATA','Data']
      ];
      var idx = -1;
      var headersUpper = [];
      $ths.each(function(){ headersUpper.push(($(this).text()||'').trim().toUpperCase()); });

      try {
        var idPos = headersUpper.indexOf('ID');
        if (idPos !== -1) {
          api.order([idPos, 'desc']).draw();
          return;
        }
      } catch(_) {}
      for (var p = 0; p < prioridades.length && idx === -1; p++) {
        var alvos = prioridades[p];
        for (var a = 0; a < alvos.length && idx === -1; a++) {
          var alvo = alvos[a].toUpperCase();
          var pos = headersUpper.indexOf(alvo);
          if (pos !== -1) idx = pos;
        }
      }
      if (idx === -1) {
        api.columns().every(function(cIdx){
          if (idx !== -1) return;
          var data = this.data();
          for (var j=0;j<Math.min(10, data.length);j++) {
            var v = data[j];
            if (typeof v === 'string' && /^\d{1,2}\/\d{1,2}\/\d{2,4}$/.test(v.trim())) {
              idx = cIdx;
              break;
            }
          }
        });
      }
      if (idx > -1) {
        api.order([idx, 'desc']).draw();
      }
    } catch(err) {
    }
  });
})();
document.addEventListener('DOMContentLoaded', function() {
  const logoutBtn = document.getElementById('logoutBtn');
  if (logoutBtn) {
    logoutBtn.addEventListener('click', function(e) {
      e.preventDefault();
      showLogoutModal();
    });
  }
});
function showLogoutModal() {
  const modal = document.createElement('div');
  modal.id = 'logoutModal';
  modal.className = 'modal fade show';
  modal.style.display = 'block';
  modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
  modal.setAttribute('tabindex', '-1');
  modal.setAttribute('role', 'dialog');
  modal.setAttribute('aria-labelledby', 'logoutModalLabel');
  modal.setAttribute('aria-hidden', 'false');

  modal.innerHTML = `
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="logoutModalLabel">
            <i class="fas fa-sign-out-alt"></i>
            Confirmar Logout
          </h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="text-center">
            <i class="fas fa-question-circle fa-3x text-warning mb-3"></i>
            <p class="mb-0">Tem certeza que deseja fazer logout?</p>
            <small class="text-muted">Você será redirecionado para a página de login.</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">
            <i class="fas fa-times"></i>
            Cancelar
          </button>
          <button type="button" class="btn btn-danger" id="confirmLogout">
            <i class="fas fa-sign-out-alt"></i>
            Fazer Logout
          </button>
        </div>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  const closeBtn = modal.querySelector('.close, .btn-close');
  const cancelBtn = modal.querySelector('.btn-secondary');
  const confirmBtn = modal.querySelector('#confirmLogout');
  function closeModal() {
    if (modal && modal.parentNode) modal.remove();
    try { document.removeEventListener('keydown', escHandler); } catch(_) {}
    try { if (window && window.closeLogoutModal) delete window.closeLogoutModal; } catch(_) {}
  }
  try { window.closeLogoutModal = closeModal; } catch(_) {}
  if (closeBtn) closeBtn.addEventListener('click', closeModal);
  if (cancelBtn) cancelBtn.addEventListener('click', closeModal);
  modal.addEventListener('click', function(e) {
    if (e.target === modal) {
      closeModal();
    }
  });
  function escHandler(e) { if (e.key === 'Escape') closeModal(); }
  document.addEventListener('keydown', escHandler);
  if (confirmBtn) confirmBtn.addEventListener('click', function() {
    fetch('/logout', {
      method: 'GET',
      credentials: 'same-origin'
    })
    .then(response => {
      if (response.ok) {
        window.location.href = '/loginPage';
      } else {
        console.error('Erro no logout');
        window.location.href = '/loginPage';
      }
    })
    .catch(error => {
      console.error('Erro na requisição de logout:', error);
      window.location.href = '/loginPage';
    });
  });
}
document.addEventListener('DOMContentLoaded', function() {
  const usernameElement = document.getElementById('loggedUserName');
  if (usernameElement) {
    const currentUsername = usernameElement.textContent.trim();
    if (currentUsername && currentUsername !== 'Usuário') {
      localStorage.setItem('portalUsername', currentUsername);
    }
    
    if (!currentUsername || currentUsername === 'Usuário') {
      const savedUsername = localStorage.getItem('portalUsername');
      if (savedUsername) {
        usernameElement.textContent = savedUsername;
      }
    }
  }
});

let originalFetch = window.fetch;
window.fetch = function(...args) {
  return originalFetch.apply(this, args).then(response => {
    if (response.status === 401 || response.status === 403) {
      if (response.url && !response.url.includes('/loginPage')) {
        window.location.href = '/loginPage?error=session_expired';
        return Promise.reject(new Error('Sessão expirada'));
      }
    }
    return response;
  }).catch(error => {
    if (error.message && error.message.includes('401')) {
      window.location.href = '/loginPage?error=session_expired';
    }
    throw error;
  });
};
</script>
