<!DOCTYPE html>
<html>
<head>
  <title>Login</title>
  <%- include('headIncludes.ejs') %> 
</head>
<body class="d-flex align-items-center min-vh-100" style="background-image: url('/css/Background.png'); background-size: cover; background-position: center; background-repeat: no-repeat; padding-top: 8vh;">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-md-6">
        <div class="card">
          <div class="card-header text-center" style="background: linear-gradient(135deg, #2B286F 100%); border: none;">
            <div class="d-flex align-items-center justify-content-center mb-2">
              <img src="/css/logo-cini.png" alt="Cini" style="height: 40px; margin-right: 15px;">
              <h2 class="text-white mb-0">Login</h2>
            </div>
            <h6 class="text-white mb-0">Utilizar as mesmas credenciais do Protheus.</h6>
            <% if (typeof req !== 'undefined' && req.query.logout === 'true') { %>
              <div class="alert alert-info mt-2" role="alert" style="border-left: 4px solid #17a2b8;">
                <div class="d-flex align-items-center">
                  <i class="fas fa-sign-out-alt me-2" style="font-size: 1.2em;"></i>
                  <div>
                    <strong>Logout realizado com sucesso</strong><br>
                    <small>Você foi desconectado com segurança. Faça login novamente quando desejar.</small>
                  </div>
                </div>
              </div>
            <% } %>
            <% if (typeof error !== 'undefined' && error === 'invalid_credentials') { %>
              <div id="errorAlert" class="alert alert-danger mt-2" role="alert" style="border-left: 4px solid #dc3545;">
                <div class="d-flex align-items-center">
                  <i class="fas fa-exclamation-triangle me-2" style="font-size: 1.2em;"></i>
                  <div>
                    <strong>Login falhou!</strong><br>
                    <small>Verifique seu usuário e senha.</small>
                  </div>
                </div>
              </div>
            <% } %>
          </div>
          <div class="card-body">
            <form id="loginForm">
              <div class="form-group">
                <label for="username">Usuário:</label>
                <input type="text" class="form-control" id="username" name="username" required>
              </div>
              <div class="form-group">
                <label for="password">Senha:</label>
                <div style="position: relative;">
                  <input type="password" class="form-control" id="password" name="password" required style="padding-right: 45px;">
                  <button class="btn" type="button" id="togglePassword" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); z-index: 10; border: none; background: none; padding: 0; color: #6c757d; outline: none; box-shadow: none;">
                    <i class="fas fa-eye" id="toggleIcon"></i>
                  </button>
                </div>
                <div id="capsLockWarning" class="alert alert-warning mt-2" role="alert" style="display: none; border-left: 4px solid #ffc107; padding: 8px 12px; font-size: 0.875rem;">
                  <i class="fas fa-exclamation-triangle me-2"></i>
                  <strong>Caps Lock está ativado!</strong>
                </div>
              </div>
              <div class="text-center mt-4">
                <button type="submit" id="loginBtn" class="btn" style="background: linear-gradient(135deg, #2B286F 100%); border: none; color: white; padding: 10px 30px; font-weight: 600;">
                  <span id="loading" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true" style="display: none;"></span>
                  <span id="btnText">Entrar</span>
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>  
  <%- include('bodyIncludes.ejs') %>
  <style>
    #togglePassword:hover {
      background: none !important;
      color: #6c757d !important;
      border: none !important;
      box-shadow: none !important;
    }
    
    #togglePassword:focus {
      background: none !important;
      color: #6c757d !important;
      border: none !important;
      box-shadow: none !important;
      outline: none !important;
    }
    
    #togglePassword:active {
      background: none !important;
      color: #6c757d !important;
      border: none !important;
      box-shadow: none !important;
    }
    
    
    .alert-warning {
      box-shadow: 0 4px 8px rgba(255, 193, 7, 0.3);
    }
    
  </style>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const errorAlert = document.getElementById('errorAlert');
      if (errorAlert) {
        setTimeout(function() {
          errorAlert.style.transition = 'opacity 0.5s ease-out';
          errorAlert.style.opacity = '0';
          setTimeout(function() {
            errorAlert.style.display = 'none';
          }, 500);
        }, 2000);
      }
      
      const urlParams = new URLSearchParams(window.location.search);
      console.log('URL params:', window.location.search);
      console.log('Timeout param:', urlParams.get('timeout'));
      
      if (urlParams.get('timeout') === 'true') {
        const timeoutMessage = document.createElement('div');
        timeoutMessage.id = 'timeout-alert';
        timeoutMessage.className = 'alert alert-warning mt-2';
        timeoutMessage.setAttribute('role', 'alert');
         timeoutMessage.style.cssText = 'border-left: 4px solid #ffc107; background-color: #fff3cd; border-color: #ffeaa7;';
         timeoutMessage.innerHTML = `
           <strong>⏰ Sessão expirada por inatividade.</strong> Você foi desconectado automaticamente. Faça login novamente para continuar.
         `;
        const h6Element = document.querySelector('h6.text-white.mb-0');
        if (h6Element) {
          h6Element.parentNode.insertBefore(timeoutMessage, h6Element.nextSibling);
        }
        
        if (!document.getElementById('username').value) {
          document.getElementById('username').value = '';
        }
        if (!document.getElementById('password').value) {
          document.getElementById('password').value = '';
        }

        document.getElementById('username').focus();
        window.scrollTo(0, 0);
        setTimeout(() => {
          const timeoutAlert = document.getElementById('timeout-alert');
          if (timeoutAlert) {
            timeoutAlert.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        }, 100);
      }
    });

    document.getElementById('togglePassword').addEventListener('click', function() {
      const passwordField = document.getElementById('password');
      const toggleIcon = document.getElementById('toggleIcon');
      
      if (passwordField.type === 'password') {
        passwordField.type = 'text';
        toggleIcon.classList.remove('fa-eye');
        toggleIcon.classList.add('fa-eye-slash');
      } else {
        passwordField.type = 'password';
        toggleIcon.classList.remove('fa-eye-slash');
        toggleIcon.classList.add('fa-eye');
      }
    });

    const passwordField = document.getElementById('password');
    const capsLockWarning = document.getElementById('capsLockWarning');
    
    function checkCapsLock(e) {
      const capsLockOn = e.getModifierState && e.getModifierState('CapsLock');
      if (capsLockOn) {
        capsLockWarning.style.display = 'block';
      } else {
        capsLockWarning.style.display = 'none';
      }
    }
    
    passwordField.addEventListener('keydown', checkCapsLock);
    passwordField.addEventListener('keyup', checkCapsLock);
    passwordField.addEventListener('focus', function(e) {
      if (e.getModifierState && e.getModifierState('CapsLock')) {
        capsLockWarning.style.display = 'block';
      }
    });
    passwordField.addEventListener('blur', function() {
      capsLockWarning.style.display = 'none';
    });

    document.getElementById('loginForm').addEventListener('submit', function(e) {
      e.preventDefault();

      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const loginBtn = document.getElementById('loginBtn');
      const loading = document.getElementById('loading');
      const btnText = document.getElementById('btnText');
      loginBtn.disabled = true;
      loading.style.display = 'inline-block';
      btnText.textContent = 'Entrando...';

      fetch('/login', {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ username, password }),
        redirect: 'follow'
      })
      .then(response => {
        if (response.redirected) {
          window.location.href = response.url;
          return;
        }
        if (response.ok) {
          return response.json().then(data => {
            console.log('Login response:', data);
            if (data && data.redirect) {
              window.location.href = data.redirect;
            } else {
              window.location.href = '/dashboard';
            }
          });
        } else {
          throw new Error('Falha no login');
        }
      })
      .catch(error => {
        console.error('Erro ao realizar login:', error);
        window.location.href = '/loginPage?error=invalid_credentials';
      });
    });
  </script>

</body>
</html>
