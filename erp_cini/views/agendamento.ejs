<!DOCTYPE html>
<html>
  <head>
    <title>Formulário Agendamento</title>
    <%- include('System/headIncludes.ejs') %>
    <style>
      .top-actions { display:flex; justify-content:flex-end; align-items:center; margin-bottom:12px; }
      .custom-table td, .custom-table th { font-size:13px; }
      .dataTables_wrapper .dt-length { margin-right: 8px; }
      .dataTables_wrapper .dataTables_filter { margin: 0; }
      .dataTables_wrapper .dataTables_filter label { display:flex; align-items:center; gap:8px; margin:0; }
      .dataTables_wrapper .dataTables_filter input { margin:0; }
      .dataTables_wrapper .dt-buttons { display:flex; align-items:center; }
      .dataTables_wrapper .dt-buttons .dt-button, .dataTables_wrapper .dt-buttons .btn { margin-left:16px; margin-top:6px; }
      .status-concluida {
        background: #d4edda !important;
        color: #155724 !important;
        font-weight: bold;
      }
      .status-pendente {
        background: #fff3cd !important;
        color: #856404 !important;
        font-weight: bold;
      }
      .status-nao-concluida {
        background: #f8d7da !important;
        color: #721c24 !important;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div class="layout-container">
      <%- include('partials/sidebar') %>
      <div class="main-content">
        <div class="topbar">
          <div class="topbar-left">
            <div class="page-info">
              <h1>Agendamentos</h1>
              <p>Gerencie os agendamentos</p>
            </div>
          </div>
          <div class="topbar-right">
            <%- include('partials/userMenu') %>
          </div>
        </div>

        <div class="content p-3">
                          <% var agendamentosAtrasados = (agendamentos && agendamentos.length) ? agendamentos.filter(function(a){
                            var st = (a.status || '').toString().toLowerCase();
                            var data = a.data_hora || a.dataHora || a.DataHora;
                            var atrasado = false;
                            if (st === 'pendente' && data) {
                              try {
                                var agora = new Date();
                                var d = new Date(data);
                                if (!isNaN(d) && d < agora) atrasado = true;
                              } catch(_){}
                            }
                            return atrasado;
                          }) : []; %>
                  <div class="widgets-grid mb-4">
                    <div class="widget clickable-widget" onclick="window.location.href='/dashboard'" style="cursor:pointer;">
                      <div class="widget-content"><h3><%= agendamentos ? agendamentos.length : 0 %></h3><p>Total de Agendamentos</p></div>
                      <div class="widget-icon primary"><i class="bi bi-calendar-check"></i></div>
                    </div>

                    <div class="widget clickable-widget" onclick="window.location.href='/dashboard'" style="cursor:pointer;">
                      <div class="widget-content"><h3><%= agendamentos ? agendamentos.filter(a => (a.status || '').toString().toLowerCase() === 'pendente').length : 0 %></h3><p>Pendentes</p></div>
                      <div class="widget-icon warning"><i class="bi bi-hourglass-split"></i></div>
                    </div>

                    <div class="widget clickable-widget" onclick="window.location.href='/dashboard'" style="cursor:pointer;">
                      <div class="widget-content"><h3><%= agendamentos ? agendamentos.filter(a => (a.status || '').toString().toLowerCase() === 'concluída' || (a.status || '').toString().toLowerCase() === 'concluida').length : 0 %></h3><p>Concluídos</p></div>
                      <div class="widget-icon success"><i class="bi bi-check-circle"></i></div>
                    </div>

                    <div class="widget clickable-widget" onclick="window.location.href='/dashboard'" style="cursor:pointer;">
                      <div class="widget-content"><h3><%= agendamentosAtrasados ? agendamentosAtrasados.length : 0 %></h3><p>Atrasados</p></div>
                      <div class="widget-icon danger"><i class="bi bi-exclamation-triangle"></i></div>
                    </div>
                  </div>
          <div class="top-actions">
            <div>
              <button id="btnNovo" class="btn btn-primary"><i class="fas fa-plus"></i> Cadastrar Agendamento</button>
            </div>
          </div>
          

          <div class="card">
            <div class="card-body">
          <table id="dataTable" class="table table-bordered custom-table" style="width:100%">
            <thead>
              <tr>
                <% if (agendamentos && agendamentos.length) { %>
                  <% 
                     const keys = Object.keys(agendamentos[0]);
                     const preferred = ['id','data_hora','dataHora','DataHora','tipo','assunto','nome','responsavel','telefone','cpf_cnpj','status','criado_por','dt_criacao'];
                     const ordered = [];
                     preferred.forEach(k=>{ if (keys.indexOf(k)!==-1 && ordered.indexOf(k)===-1) ordered.push(k); });
                     keys.forEach(k=>{ if (ordered.indexOf(k)===-1) ordered.push(k); });
                  %>
                  <% for(let i=0;i<ordered.length;i++){ const k = ordered[i]; %>
                    <th><%= k.replace(/_/g,' ').replace(/\b\w/g, l=>l.toUpperCase()) %></th>
                  <% } %>
                  <th class="actions-col">Ações</th>
                <% } else { %>
                  <th>ID</th>
                  <th>Data / Hora</th>
                  <th>Tipo</th>
                  <th>Assunto</th>
                  <th>Nome</th>
                  <th>Responsável</th>
                  <th>Telefone</th>
                  <th>CPF/CNPJ</th>
                  <th>Status</th>
                  <th class="actions-col">Ações</th>
                <% } %>
              </tr>
            </thead>
            <tbody>
              <% if (agendamentos && agendamentos.length) {
                   const keys = Object.keys(agendamentos[0]);
                   const preferred = ['id','data_hora','dataHora','DataHora','tipo','assunto','nome','responsavel','telefone','cpf_cnpj','status','criado_por','dt_criacao'];
                   const ordered = [];
                   preferred.forEach(k=>{ if (keys.indexOf(k)!==-1 && ordered.indexOf(k)===-1) ordered.push(k); });
                   keys.forEach(k=>{ if (ordered.indexOf(k)===-1) ordered.push(k); });
                   agendamentos.forEach(function(a){
                %>
                  <tr>
                    <% ordered.forEach(function(col){
                         let raw = a[col];
                         let display = raw;
                         if (col === 'tipo') {
                           try {
                             var alt = a['tipo_outro'] || a.tipo_outro;
                             if (alt && String(alt).trim()) { display = alt; }
                           } catch(_) {}
                         }
                         let extraClass = '';
                         if (col) {
                           const low = col.toLowerCase();
                           if (low.indexOf('dt_criacao') !== -1 || low.indexOf('dt criação') !== -1) {
                             try {
                               if (typeof raw === 'string') {
                                 const m = raw.match(/(\d{4})-(\d{2})-(\d{2})[T\s](\d{2}):(\d{2})/);
                                 if (m) {
                                   display = m[3] + '/' + m[2] + '/' + m[1] + ' ' + m[4] + ':' + m[5];
                                 } else {
                                   const d = new Date(raw);
                                   if (!isNaN(d)) display = d.toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                                 }
                               }
                             } catch(_){ }
                           } else if (low === 'data_hora' || low.includes('data') || low.includes('hora')) {
                             try {
                               const d = new Date(raw);
                               if (!isNaN(d)) display = d.toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                             } catch(_){ }
                           }
                           if (low === 'status') {
                             if (typeof raw === 'string') {
                               const lowv = raw.toLowerCase();
                               if (lowv.indexOf('não') !== -1 || lowv.indexOf('nao') !== -1) extraClass = 'status-nao-concluida';
                               else if (lowv.indexOf('conclu') !== -1) extraClass = 'status-concluida';
                               else if (lowv.indexOf('pend') !== -1) extraClass = 'status-pendente';
                             }
                           }
                         }
                    %>
                      <td class="cell-tooltip <%= (col && (col.toLowerCase()==='data_hora' || col.toLowerCase().includes('data') || col.toLowerCase().includes('hora') || col.toLowerCase().indexOf('dt_criacao')!==-1)) ? 'datetime-cell' : '' %> <%= extraClass %>" title="<%= display %>" data-dt="<%= raw %>"><%= display %></td>
                    <% }) %>
                    <td class="actions-col text-center">
                      <button type="button" class="btn btn-danger btn-icon-sm btn-excluir-carga btn-excluir-agendamento" data-id="<%= a.id %>" title="Excluir">
                        <i class="fas fa-trash"></i>
                      </button>
                    </td>
                  </tr>
                <% }) %>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>

      <div class="card mt-3 mb-4">
        <div class="card-header">Gráficos</div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <canvas id="chartStatus"></canvas>
            </div>
            <div class="col-md-6">
              <canvas id="chartTipo"></canvas>
            </div>
          </div>
          <div class="row mt-3">
            <div class="col-12">
              <canvas id="chartPorDia"></canvas>
            </div>
          </div>
        </div>
      </div>

      <div class="modal fade" id="modalAgendamento" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Cadastrar Agendamento</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <form id="formAgendamento">
                <div class="row g-2">
                  <div class="col-md-6">
                    <label class="form-label">Tipo</label>
                    <select id="tipo" name="tipo" class="form-control" required>
                      <option value="Visita">Visita</option>
                      <option value="Prestacao de Servicos">Prestação de Serviços</option>
                      <option value="Fornecedor">Fornecedor</option>
                      <option value="Outro">Outro</option>
                    </select>
                  </div>
                  <div class="col-md-6" id="outroTipoContainer" style="display:none;">
                    <label class="form-label">Especificar outro</label>
                    <input type="text" id="tipo_outro" name="tipo_outro" class="form-control">
                  </div>

                  <div class="col-md-6">
                    <label class="form-label">Data / Hora</label>
                    <input type="datetime-local" id="data_hora" name="data_hora" class="form-control" required>
                  </div>

                  <div class="col-md-12">
                    <label class="form-label">Assunto / Descrição</label>
                    <textarea id="assunto" name="assunto" class="form-control" rows="3" required></textarea>
                  </div>

                  <div class="col-md-6">
                    <label class="form-label">Nome</label>
                    <input type="text" id="nome" name="nome" class="form-control" required>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Responsável interno</label>
                    <div class="position-relative">
                      <input type="text" id="responsavelInput" class="form-control" placeholder="Digite para buscar..." autocomplete="off">
                      <ul id="responsavelDropdown" class="dropdown-menu w-100" style="max-height:180px;overflow-y:auto;position:absolute;top:100%;left:0;z-index:1050;display:none;"></ul>
                      <input type="hidden" id="responsavel" name="responsavel">
                    </div>
                  </div>

                  <div class="col-md-6 d-flex align-items-center mb-3 mt-3">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="1" id="euSouResponsavel" name="eu_sou_o_responsavel">
                      <label class="form-check-label" for="euSouResponsavel">
                        Eu sou o responsável 
                      </label>
                    </div>
                  </div>
                  <div class="col-md-12">
                    <label class="form-label">Observações</label>
                    <textarea id="observacoes" name="observacoes" class="form-control" rows="2"></textarea>
                  </div>
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
              <button type="button" id="saveAgendamento" class="btn btn-primary">Salvar Agendamento</button>
            </div>
          </div>
        </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <div class="modal fade" id="confirmDeleteModalAgendamento" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Confirmar exclusão</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>Tem certeza que deseja excluir este agendamento?</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" id="confirmDeleteAgendamento" class="btn btn-danger">Excluir</button>
          </div>
        </div>
      </div>
    </div>
    <%- include('System/bodyIncludes.ejs') %>
    <script>
      document.addEventListener('DOMContentLoaded', function(){
        var dataTable = $('#dataTable').DataTable({
          autoWidth: false,
          dom: "<'top'<'d-flex justify-content-between'<'dt-length'l><'d-flex justify-content-end align-items-center'<'dt-search'f><'dt-buttons ms-2'B>>>>rtip",
          buttons: [
            {
              extend: 'excelHtml5',
              text: '<i class="fas fa-file-excel"></i> Excel',
              titleAttr: 'Exportar para Excel',
              className: 'btn btn-success btn-sm'
            }
          ],
          lengthMenu: [[10, 25, 50, -1], [10, 25, 50, 'Todos']],
          pageLength: 10,
          language: {
            decimal: ",",
            thousands: ".",
            emptyTable: "Nenhum registro encontrado",
            info: "Mostrando _START_ a _END_ de _TOTAL_ registros",
            infoEmpty: "Mostrando 0 a 0 de 0 registros",
            infoFiltered: "(filtrado de _MAX_ registros)",
            lengthMenu: "Mostrar _MENU_ registros",
            loadingRecords: "Carregando...",
            processing: "Processando...",
            search: "Pesquisar:",
            zeroRecords: "Nenhum registro encontrado",
            paginate: {
              first: "Primeiro",
              last: "Último",
              next: "Próximo",
              previous: "Anterior"
            },
            aria: {
              sortAscending: ": Ordenar colunas de forma ascendente",
              sortDescending: ": Ordenar colunas de forma descendente"
            },
            select: {
              rows: {
                _: "%d linhas selecionadas",
                0: "Nenhuma linha selecionada",
                1: "1 linha selecionada"
              }
            },
            buttons: {
              copyTitle: 'Copiar para a área de transferência',
              copySuccess: {
                _: '%d linhas copiadas',
                1: '1 linha copiada'
              }
            }
          }
        });
        function formatDatetimeCells(selector){
          selector = selector || '.datetime-cell';
          document.querySelectorAll(selector).forEach(function(td){
            try{
              var raw = td.getAttribute('data-dt') || td.getAttribute('title') || td.textContent || '';
              var formatted = raw;
              if (typeof raw === 'string'){
                var m = raw.match(/(\d{4})-(\d{2})-(\d{2})[T\s](\d{2}):(\d{2})/);
                if (m) formatted = m[3] + '/' + m[2] + '/' + m[1] + ' ' + m[4] + ':' + m[5];
                else { var d = new Date(raw); if (!isNaN(d)) formatted = d.toLocaleString('pt-BR', { day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' }); }
              }
              td.textContent = formatted;
              td.setAttribute('title', formatted);
            }catch(_){ }
          });
        }
        try{ if (dataTable && dataTable.on) dataTable.on('draw', function(){ formatDatetimeCells('.datetime-cell'); }); }catch(_){ }
        try { formatDatetimeCells('.datetime-cell'); } catch(_){ }

        const modalEl = document.getElementById('modalAgendamento');
        const bsModal = new bootstrap.Modal(modalEl);

        document.getElementById('btnNovo').addEventListener('click', function(){
          document.getElementById('formAgendamento').reset();
          document.getElementById('outroTipoContainer').style.display = 'none';
          bsModal.show();
        });

        document.getElementById('tipo').addEventListener('change', function(e){
          if (e.target.value === 'Outro') document.getElementById('outroTipoContainer').style.display = '';
          else document.getElementById('outroTipoContainer').style.display = 'none';
        });

        document.getElementById('saveAgendamento').addEventListener('click', function(){
          let responsavelObj = null;
          try {
            responsavelObj = JSON.parse(document.getElementById('responsavel').value);
          } catch (e) {}
          const euSou = document.getElementById('euSouResponsavel') && document.getElementById('euSouResponsavel').checked;
          if (!euSou) {
            if (!responsavelObj || !responsavelObj.raNumCelu || !responsavelObj.raNome) {
              alert('Selecione um responsável interno válido ou marque "Eu sou o responsável".');
              return;
            }
          } else {
            responsavelObj = null;
          }
          function stripNonDigits(v){ return String(v||'').replace(/\D+/g,''); }
          const telEl = document.getElementById('telefone');
          const cpfEl = document.getElementById('cpf_cnpj');
          const telefoneRaw = telEl ? telEl.value : '';
          const cpfCnpjRaw = cpfEl ? cpfEl.value : '';
          const data = {
            tipo: document.getElementById('tipo').value,
            tipo_outro: document.getElementById('tipo_outro').value,
            data_hora: document.getElementById('data_hora').value,
            assunto: document.getElementById('assunto').value,
            nome: document.getElementById('nome').value,
            responsavel: responsavelObj,
            observacoes: document.getElementById('observacoes').value,
            eu_sou_o_responsavel: euSou
          };
          if (!data.data_hora || !data.assunto || !data.nome) { alert('Preencha os campos obrigatórios'); return; }

          fetch('/agendamentos', {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          }).then(r => r.json()).then(resp => {
            if (resp && resp.success) {
              location.reload();
            } else {
              alert('Erro ao salvar: ' + (resp && resp.message || 'Erro'));
            }
          }).catch(err => { console.error(err); alert('Erro ao salvar'); });
        });

        try {
          var confirmEl = document.getElementById('confirmDeleteModalAgendamento');
          var confirmModal = confirmEl ? new bootstrap.Modal(confirmEl) : null;
          var deleteTargetId = null;
          $('#dataTable').on('click', '.btn-excluir-agendamento', function(){
            deleteTargetId = $(this).data('id');
            if (confirmModal) confirmModal.show();
          });
          if (document.getElementById('confirmDeleteAgendamento')) {
            document.getElementById('confirmDeleteAgendamento').addEventListener('click', function(){
              if (!deleteTargetId) return;
              fetch('/agendamentos/delete', {
                method: 'POST',
                credentials: 'same-origin',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: deleteTargetId })
              }).then(async function(res){
                var ct = res.headers.get('content-type') || '';
                var body = ct.indexOf('application/json') !== -1 ? await res.json() : await res.text();
                if (res.ok && body && body.success) {
                  location.reload();
                } else {
                  alert('Erro ao excluir: ' + (body && body.message || JSON.stringify(body)));
                }
              }).catch(function(e){ console.error(e); alert('Erro ao excluir'); }).finally(function(){
                if (confirmModal) confirmModal.hide();
                deleteTargetId = null;
              });
            });
          }
        } catch(_){ }
      });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
      (function(){
        const agendamentos = <%- JSON.stringify(agendamentos || []) %>;
        function safeStr(v){ return v==null ? '' : String(v); }
        const statusCounts = {};
        const tipoCounts = {};
        const dayCounts = {};

        agendamentos.forEach(function(a){
          const status = (safeStr(a.status) || 'Pendente');
          statusCounts[status] = (statusCounts[status] || 0) + 1;
          const tipo = (safeStr(a.tipo_outro).trim()) ? a.tipo_outro : (safeStr(a.tipo) || 'Outro');
          tipoCounts[tipo] = (tipoCounts[tipo] || 0) + 1;
          const dRaw = a.data_hora || a.dataHora || a.DataHora;
          if (dRaw) {
            const d = new Date(dRaw);
            if (!isNaN(d)) {
              const key = d.getFullYear() + '-' + (d.getMonth()+1) + '-' + d.getDate();
              dayCounts[key] = (dayCounts[key] || 0) + 1;
            }
          }
        });

        const colors = ['#007bff','#28a745','#ffc107','#dc3545','#6f42c1','#17a2b8','#fd7e14','#20c997'];
        function createChart(id,type,labels,data,options){
          const el = document.getElementById(id);
          if (!el) return;
          new Chart(el, {
            type: type,
            data: {
              labels: labels,
              datasets: [{
                label: options && options.label || '',
                data: data,
                backgroundColor: options && options.backgroundColor || labels.map((_,i)=>colors[i%colors.length]),
                borderColor: options && options.borderColor || labels.map((_,i)=>colors[i%colors.length]),
                tension: 0.2
              }]
            },
            options: Object.assign({
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { position: 'bottom' } }
            }, options && options.options || {})
          });
        }

        const statusLabels = Object.keys(statusCounts);
        const statusData = statusLabels.map(l=>statusCounts[l]);
        const tipoLabels = Object.keys(tipoCounts);
        const tipoData = tipoLabels.map(l=>tipoCounts[l]);
        const dayKeys = Object.keys(dayCounts).sort(function(a,b){ return new Date(a) - new Date(b); });
        const dayLabels = dayKeys;
        const dayData = dayKeys.map(k=>dayCounts[k]);
        function setH(id,h){ const c = document.getElementById(id); if(c) c.style.height = h + 'px'; }
        setH('chartStatus', 240); setH('chartTipo', 240); setH('chartPorDia', 220);

        createChart('chartStatus','doughnut',statusLabels,statusData,{label:'Status'});
        createChart('chartTipo','bar',tipoLabels,tipoData,{label:'Por Tipo', options:{ scales:{ y: { beginAtZero:true } } }});
        createChart('chartPorDia','line',dayLabels,dayData,{label:'Por Dia', options:{ scales:{ y: { beginAtZero:true } } }});
      })();
    </script>
    <script>
      (function(){
        function strip(v){ return String(v||'').replace(/\D+/g,''); }
        function formatPhoneDigits(d){
          var ds = strip(d).slice(0,11);
          var len = ds.length;
          if (len === 0) return '';
          if (len <= 2) return '('+ds;
          if (len <= 6) return '('+ds.slice(0,2)+') '+ds.slice(2);
          if (len <= 10) return '('+ds.slice(0,2)+') '+ds.slice(2,6)+'-'+ds.slice(6);
          return '('+ds.slice(0,2)+') '+ds.slice(2,3)+' '+ds.slice(3,7)+'-'+ds.slice(7);
        }

        function formatCpfCnpjDigits(v){
          var d = strip(v);
          if (d.length <= 11){
            var s = d;
            if (s.length <= 3) return s;
            if (s.length <= 6) return s.slice(0,3)+'.'+s.slice(3);
            if (s.length <= 9) return s.slice(0,3)+'.'+s.slice(3,6)+'.'+s.slice(6);
            return s.slice(0,3)+'.'+s.slice(3,6)+'.'+s.slice(6,9)+'-'+s.slice(9,11);
          } else {
            var s = d.slice(0,14);
            if (s.length <= 2) return s;
            if (s.length <= 5) return s.slice(0,2)+'.'+s.slice(2);
            if (s.length <= 8) return s.slice(0,2)+'.'+s.slice(2,5)+'.'+s.slice(5);
            if (s.length <= 12) return s.slice(0,2)+'.'+s.slice(2,5)+'.'+s.slice(5,8)+'/'+s.slice(8);
            return s.slice(0,2)+'.'+s.slice(2,5)+'.'+s.slice(5,8)+'/'+s.slice(8,12)+'-'+s.slice(12,14);
          }
        }

        var telEl = document.getElementById('telefone');
        var cpfEl = document.getElementById('cpf_cnpj');
        if (telEl){
          telEl.addEventListener('input', function(e){
            var formatted = formatPhoneDigits(this.value);
            this.value = formatted;
            this.selectionStart = this.selectionEnd = this.value.length;
          });
          telEl.addEventListener('blur', function(){ this.value = formatPhoneDigits(this.value); });
        }
        if (cpfEl){
          cpfEl.addEventListener('input', function(e){
            var formatted = formatCpfCnpjDigits(this.value);
            this.value = formatted;
            this.selectionStart = this.selectionEnd = this.value.length;
          });
          cpfEl.addEventListener('blur', function(){ this.value = formatCpfCnpjDigits(this.value); });
        }
      })();
    </script>
    <script>
      (function(){
        var users = [];
        <% if (users && users.length) { %>
          users = [
            <% users.forEach(function(u, idx, arr){ %>
              { id: <%- JSON.stringify(u.RA_MAT || '') %>, nome: <%- JSON.stringify(u.RA_NOME || '') %>, raNumCelu: <%- JSON.stringify((u.RA_DDDCELU||'') + (u.RA_NUMCELU ? String(u.RA_NUMCELU) : (u.RA_TELEFON||''))) %>, raNome: <%- JSON.stringify(u.RA_NOME || '') %> }<%= idx < arr.length-1 ? ',' : '' %>
            <% }) %>
          ];
        <% } %>

        fetch('/api/responsaveis').then(async r => {
          const ct = r.headers.get('content-type') || '';
          if (!r.ok) {
            const txt = await r.text();
            console.error('API /api/responsaveis returned non-ok status', r.status, txt);
            return null;
          }
          if (ct.indexOf('application/json') !== -1) {
            return r.json();
          }
          const text = await r.text();
          console.error('API /api/responsaveis returned non-JSON body:', text);
          return null;
        }).then(resp => {
          if (resp && resp.success && Array.isArray(resp.data) && resp.data.length) {
            users = resp.data.map(function(u){
              return {
                id: u.RA_MAT || u.RA_MAT,
                nome: u.RA_NOME || '',
                raNumCelu: (u.RA_DDDCELU||'') + (u.RA_NUMCELU ? String(u.RA_NUMCELU) : (u.RA_TELEFON||'')),
                raNome: u.RA_NOME || ''
              };
            });
          }
        }).catch(err => { console.error('Erro ao buscar responsaveis via API:', err); });
        var input = document.getElementById('responsavelInput');
        var dropdown = document.getElementById('responsavelDropdown');
        var hidden = document.getElementById('responsavel');
        if (!input || !dropdown || !hidden) return;

        function normalizeStr(s) {
          try {
            return String(s || '')
              .normalize('NFD')
              .replace(/\p{Diacritic}/gu, '')
              .replace(/\s+/g, ' ')
              .trim()
              .toLowerCase();
          } catch (e) {
            return String(s || '').toLowerCase();
          }
        }

        function matchesName(name, filter) {
          if (!filter) return true;
          var normName = normalizeStr(name);
          var tokens = normalizeStr(filter).split(' ').filter(function(t){ return t; });
          return tokens.every(function(t){ return normName.indexOf(t) !== -1; });
        }

        function renderDropdown(filter) {
          dropdown.innerHTML = '';
          var filtered = users.filter(function(u){
            return matchesName(u.nome || u.raNome || '', filter || '');
          });
          if (!filtered.length) {
            dropdown.style.display = 'none';
            return;
          }
          filtered.forEach(function(u){
            var li = document.createElement('li');
            li.className = 'dropdown-item';
            li.textContent = u.nome;
            li.setAttribute('data-id', u.id);
            li.setAttribute('data-raNumCelu', u.raNumCelu);
            li.setAttribute('data-raNome', u.raNome);
            li.style.cursor = 'pointer';
            li.onclick = function(){
              input.value = u.nome;
              hidden.value = JSON.stringify(u);
              dropdown.style.display = 'none';
            };
            dropdown.appendChild(li);
          });
          dropdown.style.display = 'block';
        }

        input.addEventListener('input', function(){
          hidden.value = '';
          renderDropdown(input.value);
        });
        input.addEventListener('focus', function(){
          renderDropdown(input.value);
        });
        input.addEventListener('blur', function(){
          setTimeout(function(){ dropdown.style.display = 'none'; }, 200);
        });
      })();
    </script>
  </body>
</html>
