<!DOCTYPE html>
<html lang="pt-br">
<head>
  <%- include('System/headIncludes.ejs') %>
  <title>Cargas Portaria | ERP CINI</title>
  <style>
    .btn-icon-sm {
      padding: 0 !important;
      font-size: 0.55rem !important;
      line-height: 1 !important;
      border-radius: 0.15rem !important;
      display: inline-flex !important;
      align-items: center;
      justify-content: center;
        width: 32px !important;
        height: 16px !important;
        min-width: 32px !important;
        min-height: 16px !important;
      border-width: 1px !important;
    }
      .btn-icon-sm {
        border-radius: 4px !important;
      }
    .btn-icon-sm i { margin: 0; font-size: 0.7rem !important; }
    .btn-icon-sm:focus,
    .btn-icon-sm:hover {
      box-shadow: none !important;
    }
    .status-concluida { background: #d4edda !important; color: #155724 !important; font-weight: 600; padding:4px 8px; border-radius:4px; }
    .status-pendente { background: #fff3cd !important; color: #856404 !important; font-weight: 600; padding:4px 8px; border-radius:4px; }
    .status-nao-concluida { background: #f8d7da !important; color: #721c24 !important; font-weight: 600; padding:4px 8px; border-radius:4px; }
  </style>
</head>
<body>
  <div class="layout-container">
    <%- include('partials/sidebar') %>
    <div class="main-content">
      <div class="topbar">
        <div class="topbar-left">
          <div class="page-info">
            <h1>Cargas Portaria</h1>
            <p>Lista de cargas disponíveis para registro na portaria</p>
          </div>
        </div>
        <div class="topbar-right">
          <%- include('partials/userMenu') %>
        </div>
      </div>

      <div class="content">
        <% var pendingCount = (cargas && cargas.length) ? cargas.length : 0; %>
        <% var concluidosCount = (typeof concluidos !== 'undefined') ? concluidos : 0; %>
        <% var totalCargas = pendingCount + concluidosCount; %>
        <% var totalPeso = 0; %>
        <% cargas && cargas.forEach(function(r){ try{ totalPeso += parseFloat(String(r.PESO || 0).toString().replace(',','.')) || 0; }catch(_){ } }); %>
          <% var hojeStart = new Date(); hojeStart.setHours(0,0,0,0); %>
          <% var concluidos = (typeof concluidos !== 'undefined') ? concluidos : ((cargas || []).filter(function(r){ try{ var d = new Date(r.DT_ENTREG); return !isNaN(d) && d < new Date(); } catch(_){ return false; } }).length);
          %>
          <% var pendentes = totalCargas - concluidos;
             var driversSet = new Set(), platesSet = new Set();
             (cargas || []).forEach(function(r){ try{
               var m = (r.MOTORISTA || r.motorista || ''), p = (r.PLACA || r.placa || '');
               if (m && String(m).trim()) driversSet.add(String(m).trim());
               if (p && String(p).trim()) platesSet.add(String(p).trim());
             }catch(_){}});
             var driversCount = driversSet.size || 0, platesCount = platesSet.size || 0;
          %>

        <div class="widgets-grid">
          <div class="widget clickable-widget" onclick="window.location.href='/cargas-portaria'" style="cursor:pointer;">
            <div class="widget-content"><h3><span id="totalCargas"><%= totalCargas %></span></h3><p>Total de Cargas</p></div>
            <div class="widget-icon primary"><i class="bi bi-truck"></i></div>
          </div>

          <div class="widget clickable-widget" onclick="window.location.href='/cargas-portaria'" style="cursor:pointer;">
            <div class="widget-content"><h3><span id="totalPeso"><%= (totalPeso || 0).toFixed(3) %></span></h3><p>Peso (kg)</p></div>
            <div class="widget-icon info"><i class="bi bi-box-seam"></i></div>
          </div>

          <div class="widget clickable-widget" onclick="window.location.href='/cargas-portaria'" style="cursor:pointer;">
            <div class="widget-content"><h3><span id="driversCount"><%= driversCount %></span></h3><p>Motoristas</p></div>
            <div class="widget-icon success"><i class="bi bi-people"></i></div>
          </div>

          <div class="widget clickable-widget" onclick="window.location.href='/cargas-portaria'" style="cursor:pointer;">
            <div class="widget-content"><h3><span id="platesCount"><%= platesCount %></span></h3><p>Placas Distintas</p></div>
            <div class="widget-icon danger"><i class="bi bi-tags"></i></div>
          </div>
        </div>

        

        <div class="card mt-20">
          <div class="card-header">Cargas</div>
          <div class="card-body">
            <table id="cargasPortariaTable" class="table table-bordered custom-table" style="width:100%">
              <thead>
                <tr>
                  <th>Filial</th>
                  <th>Carga</th>
                  <th>Data Entrega</th>
                  <th>Status</th>
                  <th>Placa</th>
                  <th>Tipo Entrega</th>
                  <th>Motorista</th>
                  <th>Peso</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody>
                <% if (cargas && cargas.length) { cargas.forEach(function(r){ %>
                  <tr>
                    <td class="cell-tooltip" title="<%= r.FILIAL %>"><%= r.FILIAL %></td>
                    <td class="cell-tooltip" title="<%= r.CARGA %>"><%= r.CARGA %></td>
                    <td class="cell-tooltip datetime-cell" title="<%= r.DT_ENTREG %>" data-dt="<%= r.DT_ENTREG %>"><%= r.DT_ENTREG %></td>
                    <td class="cell-tooltip status-cell status-pendente" title="Pendente">Pendente</td>
                    <td class="cell-tooltip" title="<%= r.PLACA %>"><%= r.PLACA %></td>
                    <td class="cell-tooltip" title="<%= r.TIPO_ENTREGA %>"><%= r.TIPO_ENTREGA %></td>
                    <td class="cell-tooltip" title="<%= r.MOTORISTA %>"><%= r.MOTORISTA %></td>
                    <td class="cell-tooltip" title="<%= r.PESO %>"><%= r.PESO %></td>
                    <td>
                      <button type="button" class="btn btn-success btn-icon-sm concluirCargaBtn"
                              data-filial="<%= (r.FILIAL||'') %>" data-carga="<%= (r.CARGA||'') %>"
                              data-dt_entrega="<%= (r.DT_ENTREG_RAW || r.DT_ENTREG || '') %>" data-placa="<%= (r.PLACA||'') %>"
                              data-tipo_entrega="<%= (r.TIPO_ENTREGA||'') %>" data-motorista="<%= (r.MOTORISTA||'') %>"
                              data-peso="<%= (r.PESO||'') %>" title="Confirmar conclusão">
                        <i class="fas fa-check"></i>
                      </button>
                    </td>
                  </tr>
                <% }); } %>
              </tbody>
            </table>
          </div>
        </div>

        <div class="grid grid-2 mt-20">
          <div class="card">
            <div class="card-header">Progresso Geral das Cargas</div>
            <div class="card-body">
              <div style="margin-bottom:16px;">
                <% var progresso = totalCargas > 0 ? Math.round((concluidos / totalCargas) * 100) : 0; %>
                <div class="flex-between mb-10"><span style="font-size:13px;">Conclusão de Cargas</span><span style="font-size:13px;font-weight:600;"><span id="progressoPercent"><%= progresso %></span>%</span></div>
                <div style="height:8px;background:var(--gray);border-radius:4px;overflow:hidden;">
                  <div id="progressoBar" style="height:100%;background:var(--primary);width:<%= progresso %>%;transition:all 0.3s ease;"></div>
                </div>
              </div>
              <table style="width:100%;font-size:13px;margin-top:16px;">
                <tr><td style="padding:8px 0;border-bottom:1px solid var(--gray);">Concluídos</td><td style="padding:8px 0;border-bottom:1px solid var(--gray);text-align:right;font-weight:600;"><span id="concluidosCount"><%= concluidos %></span></td></tr>
                <tr><td style="padding:8px 0;border-bottom:1px solid var(--gray);">Pendentes</td><td style="padding:8px 0;border-bottom:1px solid var(--gray);text-align:right;font-weight:600;"><span id="pendentesCount"><%= Math.max(0, pendentes) %></span></td></tr>
                <tr><td style="padding:8px 0;">Total</td><td style="padding:8px 0;text-align:right;font-weight:600;"><span id="totalCargasCount"><%= totalCargas %></span></td></tr>
              </table>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <%- include('System/bodyIncludes.ejs') %>

  <div class="modal fade" id="modalConcluirCarga" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirmar Registro na Portaria</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Confirma registro desta carga na tabela de portaria?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Não</button>
          <button type="button" id="confirmConcluirCarga" class="btn btn-primary">Sim, registrar</button>
        </div>
      </div>
    </div>
  </div>

    <div class="modal fade" id="cadastroModal" tabindex="-1" aria-labelledby="cadastroModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="cadastroModalLabel">Cadastrar Saída por Placa</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body">
            <form id="cadastroForm">
              <div class="row">
                <div class="col-md-4 mb-2">
                  <label class="form-label">Placa</label>
                  <div class="position-relative">
                    <input id="cadastroPlaca" class="form-control" placeholder="Digite para buscar..." autocomplete="off" />
                    <ul id="placaDropdown" class="dropdown-menu w-100" style="max-height:180px;overflow-y:auto;position:absolute;top:100%;left:0;right:0;z-index:1050;display:none;width:100%;"></ul>
                    <input type="hidden" id="placaHidden" name="placa_selected">
                  </div>
                </div>
                <div class="col-md-4 mb-2">
                  <label class="form-label">Filial</label>
                  <input id="cadastroFilial" class="form-control" />
                </div>
                <div class="col-md-4 mb-2">
                  <label class="form-label">Carga</label>
                  <input id="cadastroCarga" class="form-control" />
                </div>
              </div>
              <div class="row">
                <div class="col-md-4 mb-2">
                  <label class="form-label">Data Entrega</label>
                  <input id="cadastroDtEntrega" type="datetime-local" class="form-control" />
                </div>
                <div class="col-md-4 mb-2">
                  <label class="form-label">Tipo Entrega</label>
                  <input id="cadastroTipoEntrega" class="form-control" />
                </div>
                <div class="col-md-4 mb-2">
                  <label class="form-label">Motorista</label>
                  <input id="cadastroMotorista" class="form-control" />
                </div>
              </div>
              <div class="row">
                <div class="col-md-4 mb-2">
                  <label class="form-label">Peso</label>
                  <input id="cadastroPeso" class="form-control" />
                </div>
                <div class="col-md-8 mb-2">
                  <label class="form-label">Registros encontrados</label>
                  <div id="matchesList" class="list-group" style="max-height:200px; overflow:auto;"></div>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" id="cadastroSaveBtn" class="btn btn-primary">Salvar</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      window.cargasData = <%- JSON.stringify(typeof existing !== 'undefined' ? existing : []) %>;
      function openCadastroModal(){
        try { $('#cadastroForm')[0].reset(); $('#matchesList').empty(); $('#cadastroModal').modal('show'); } catch(e) { try { new bootstrap.Modal(document.getElementById('cadastroModal')).show(); } catch(_){ } }
      }
      (function(){
        function safe(v){ return v==null ? '' : String(v); }
        function renderMatches(matches){
          var $list = $('#matchesList');
          $list.empty();
          if (!matches || !matches.length) { $list.append('<div class="text-muted p-2">Nenhum registro encontrado</div>'); return; }
          matches.forEach(function(m, i){
            var title = (safe(m.placa) || safe(m.PLACA)) + ' — ' + (safe(m.carga) || safe(m.CARGA)) + ' — ' + (safe(m.motorista) || safe(m.MOTORISTA));
            var $it = $('<button type="button" class="list-group-item list-group-item-action match-item" data-idx="'+i+'"></button>');
            $it.text(title);
            $it.data('rec', m);
            $list.append($it);
          });
        }
        function findMatchesByPlaca(q){
          if (!q) return [];
          q = String(q).trim();
          try {
            return fetch('/cargas-portaria/find?placa=' + encodeURIComponent(q))
              .then(function(r){ return r.json(); })
              .then(function(resp){ return (resp && resp.success && Array.isArray(resp.results)) ? resp.results : (window.cargasData || []).filter(function(r){ try { return String((r.placa||r.PLACA||'')).toLowerCase().indexOf(q.toLowerCase()) !== -1; } catch(e){ return false; } }); })
              .catch(function(){ return (window.cargasData || []).filter(function(r){ try { return String((r.placa||r.PLACA||'')).toLowerCase().indexOf(q.toLowerCase()) !== -1; } catch(e){ return false; } }); });
          } catch(e){
            return (window.cargasData || []).filter(function(r){ try { return String((r.placa||r.PLACA||'')).toLowerCase().indexOf(q.toLowerCase()) !== -1; } catch(e){ return false; } });
          }
        }
        function populateFormWith(rec){ if (!rec) return; $('#cadastroFilial').val(rec.filial || rec.FILIAL || ''); $('#cadastroCarga').val(rec.carga || rec.CARGA || ''); var raw = rec.dt_entrega || rec.DT_ENTREG || rec.DT_ENTREG_RAW || rec.dt_entrega; if (raw) { try { var d = new Date(raw); if (!isNaN(d)) { var tzOffset = d.getTimezoneOffset() * 60000; var localISO = new Date(d - tzOffset).toISOString().slice(0,19); $('#cadastroDtEntrega').val(localISO); } else { $('#cadastroDtEntrega').val(''); } } catch(_) { $('#cadastroDtEntrega').val(''); } } else { $('#cadastroDtEntrega').val(''); } $('#cadastroPlaca').val(rec.placa || rec.PLACA || ''); $('#cadastroTipoEntrega').val(rec.tipo_entrega || rec.TIPO_ENTREGA || ''); $('#cadastroMotorista').val(rec.motorista || rec.MOTORISTA || ''); $('#cadastroPeso').val(rec.peso || rec.PESO || ''); }

        $('#cadastroPlaca').on('input', function(){ var q = $(this).val(); var maybe = findMatchesByPlaca(q); if (maybe && typeof maybe.then === 'function') { maybe.then(function(matches){ renderMatches(matches); if (matches && matches.length) populateFormWith(matches[0]); }); } else { renderMatches(maybe); if (maybe && maybe.length) populateFormWith(maybe[0]); } });
        $('#cadastroCarga').on('input', function(){ var q = $(this).val(); if (!q) return; try { fetch('/cargas-portaria/find?carga=' + encodeURIComponent(q)).then(function(r){ return r.json(); }).then(function(resp){ var matches = (resp && resp.success && Array.isArray(resp.results)) ? resp.results : []; renderMatches(matches); if (matches && matches.length) populateFormWith(matches[0]); }).catch(function(){ /* ignore */ }); } catch(e){} });
        $(document).on('click', '.match-item', function(){ var rec = $(this).data('rec'); populateFormWith(rec); });

        $('#cadastroSaveBtn').on('click', function(e){ e.preventDefault(); var payload = { filial: $('#cadastroFilial').val() || null, carga: $('#cadastroCarga').val() || null, dt_entrega: $('#cadastroDtEntrega').val() || null, placa: $('#cadastroPlaca').val() || null, tipo_entrega: $('#cadastroTipoEntrega').val() || null, motorista: $('#cadastroMotorista').val() || null, peso: $('#cadastroPeso').val() || null }; fetch('/cargas-portaria/concluir', { method: 'POST', credentials: 'same-origin', headers: { 'Content-Type':'application/json' }, body: JSON.stringify(payload) }).then(function(r){ return r.json(); }).then(function(json){ if (json && json.success) { try { $('#cadastroModal').modal('hide'); } catch(_){} location.reload(); } else { alert('Erro ao salvar: ' + (json && json.message ? json.message : 'erro desconhecido')); } }).catch(function(err){ console.error(err); alert('Erro ao salvar: ' + (err && err.message ? err.message : 'erro desconhecido')); }); });
      })();
    </script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      try {
        if (window.$ && $.fn && $.fn.DataTable) {
          var dataTable = $('#cargasPortariaTable').DataTable({
            autoWidth: false,
            dom: "<'top'<'d-flex justify-content-between'<'dt-length'l><'d-flex justify-content-end align-items-center'<'dt-search'f><'dt-buttons ms-2'B>>>>rtip",
            buttons: [
              {
                extend: 'excelHtml5',
                text: '<i class="fas fa-file-excel"></i> Excel',
                titleAttr: 'Exportar para Excel',
                className: 'btn btn-success btn-sm'
              }
            ],
            lengthMenu: [[5, 10, 25, -1], [5, 10, 25, 'Todos']],
            pageLength: 10,
            language: {
              decimal: ",",
              thousands: ".",
              emptyTable: "Nenhum registro encontrado",
              info: "Mostrando _START_ a _END_ de _TOTAL_ registros",
              infoEmpty: "Mostrando 0 a 0 de 0 registros",
              infoFiltered: "(filtrado de _MAX_ registros)",
              lengthMenu: "Mostrar _MENU_ registros",
              loadingRecords: "Carregando...",
              processing: "Processando...",
              search: "Pesquisar:",
              zeroRecords: "Nenhum registro encontrado",
              paginate: { first: "Primeiro", last: "Último", next: "Próximo", previous: "Anterior" }
            }
          });
          try { dataTable.on('draw', formatDatetimeCells); } catch(_){ }
          try {
            try { createColumnFilter('#cargasPortariaTable','Carga'); } catch(_){ }
            try { createColumnFilter('#cargasPortariaTable','Placa'); } catch(_){ }
            try { createColumnFilter('#cargasPortariaTable','Motorista'); } catch(_){ }
            try { createColumnFilter('#cargasPortariaTable','Status'); } catch(_){ }
            try{
              var $cf = $('#cargasPortariaTable').prev('.column-filters');
              if ($cf && $cf.length) {
                $cf.css({ 'overflow-x': 'hidden', 'flex-wrap': 'nowrap', 'gap': '6px' });
                $cf.find('input').css({ 'min-width': '120px', 'width': 'auto', 'flex': '0 0 auto' });
              }
            }catch(_){ }
          } catch(_){ }
        }
      } catch(e) { console.error('DataTable init error:', e); }
      function formatDatetimeCells() {
        document.querySelectorAll('.datetime-cell').forEach(function(td){
          try {
            var raw = td.getAttribute('title') || td.textContent || '';
            var formatted = raw;
            if (typeof raw === 'string') {
              var dtTimeMatch = raw.match(/(\d{4})-(\d{2})-(\d{2})[T\s](\d{2}):(\d{2})(?::(\d{2}))?/);
              var dtOnlyMatch = raw.match(/^(\d{4})-(\d{2})-(\d{2})$/);
              if (dtTimeMatch) {
                formatted = dtTimeMatch[3] + '/' + dtTimeMatch[2] + '/' + dtTimeMatch[1] + ' ' + dtTimeMatch[4] + ':' + dtTimeMatch[5];
              } else if (dtOnlyMatch) {
                formatted = dtOnlyMatch[3] + '/' + dtOnlyMatch[2] + '/' + dtOnlyMatch[1];
              } else {
                var d = new Date(raw);
                if (!isNaN(d)) formatted = d.toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
              }
            } else if (raw instanceof Date) {
              var dd = String(raw.getDate()).padStart(2,'0');
              var mm = String(raw.getMonth()+1).padStart(2,'0');
              var yyyy = raw.getFullYear();
              var hh = String(raw.getHours()).padStart(2,'0');
              var min = String(raw.getMinutes()).padStart(2,'0');
              formatted = dd + '/' + mm + '/' + yyyy + ' ' + hh + ':' + min;
            }
            td.textContent = formatted;
            td.setAttribute('title', formatted);
          } catch(_){ }
        });
      }

      try { formatDatetimeCells(); } catch(_){ }
      const userName = document.getElementById('userName');
      if (userName) {
        const name = '<%= user && user.nome ? user.nome : "Usuário" %>';
        const initial = name.charAt(0).toUpperCase();
        document.getElementById('userInitials').textContent = initial;
        userName.textContent = name;
      }

      var selectedData = null;
      var lastClickedBtn = null;
      try {
        var modalEl = document.getElementById('modalConcluirCarga');
        var bsModal = modalEl ? new bootstrap.Modal(modalEl) : null;
        var tableEl = document.getElementById('cargasPortariaTable');
        if (tableEl) {
          tableEl.addEventListener('click', function(e){
            var btn = e.target.closest('.concluirCargaBtn');
            if (!btn) return;
            selectedData = {
              filial: btn.getAttribute('data-filial'),
              carga: btn.getAttribute('data-carga'),
              dt_entrega: btn.getAttribute('data-dt_entrega'),
              placa: btn.getAttribute('data-placa'),
              tipo_entrega: btn.getAttribute('data-tipo_entrega'),
              motorista: btn.getAttribute('data-motorista'),
              peso: btn.getAttribute('data-peso')
            };
            lastClickedBtn = btn;
            if (bsModal) bsModal.show();
          });
        }

        var confirmBtn = document.getElementById('confirmConcluirCarga');
        if (confirmBtn) confirmBtn.addEventListener('click', function(){
          if (!selectedData) return;
            fetch('/cargas-portaria/concluir', { method: 'POST', credentials: 'same-origin', headers: { 'Content-Type':'application/json' }, body: JSON.stringify(selectedData) })
            .then(function(r){ return r.json(); })
            .then(function(resp){
                if (resp && resp.success) {
                  if (bsModal) bsModal.hide();
                  try {
                    if (lastClickedBtn) {
                      var tr = lastClickedBtn.closest('tr');
                      if (tr) tr.remove();
                    }
                  } catch(_){ }
                  try {
                    var conclEl = document.getElementById('concluidosCount');
                    var pendEl = document.getElementById('pendentesCount');
                    var totalEl = document.getElementById('totalCargasCount');
                    var progEl = document.getElementById('progressoPercent');
                    var progBar = document.getElementById('progressoBar');
                    var totalCargasEl = document.getElementById('totalCargas');
                    var totalPesoEl = document.getElementById('totalPeso');
                    var driversEl = document.getElementById('driversCount');
                    var platesEl = document.getElementById('platesCount');

                    var conclu = parseInt(conclEl ? conclEl.textContent || '0' : '0', 10) || 0;
                    conclu = conclu + 1;
                    if (conclEl) conclEl.textContent = conclu;
                    var tbody = document.querySelector('#cargasPortariaTable tbody');
                    var rows = tbody ? Array.from(tbody.querySelectorAll('tr')) : [];
                    var pending = rows.length;
                    var dSet = new Set(); var pSet = new Set(); var pesoSum = 0;
                    rows.forEach(function(r){
                      try {
                        var cols = r.querySelectorAll('td');
                        var motorista = cols[5] ? (cols[5].textContent||'').trim() : '';
                        var pesoText = cols[6] ? (cols[6].textContent||'').trim() : '';
                        var placa = cols[3] ? (cols[3].textContent||'').trim() : '';
                        if (motorista) dSet.add(motorista);
                        if (placa) pSet.add(placa);
                        var n = parseFloat(String(pesoText).replace(',','.') || '0'); if (!isNaN(n)) pesoSum += n;
                      } catch(_){ }
                    });

                    if (pendEl) pendEl.textContent = pending;
                    if (totalEl) totalEl.textContent = (pending + conclu);
                    if (totalCargasEl) totalCargasEl.textContent = (pending + conclu);
                    if (totalPesoEl) totalPesoEl.textContent = pesoSum.toFixed(3);
                    if (driversEl) driversEl.textContent = dSet.size || 0;
                    if (platesEl) platesEl.textContent = pSet.size || 0;

                    var prog = (pending + conclu) > 0 ? Math.round((conclu / (pending + conclu)) * 100) : 0;
                    if (progEl) progEl.textContent = prog;
                    if (progBar) progBar.style.width = prog + '%';
                  } catch(_){ }

                } else {
                  alert('Erro ao registrar carga');
                }
              }).catch(function(err){ console.error(err); alert('Erro ao registrar carga'); });
          });
        } catch(_){ }
    });
  </script>
</body>
</html>
