<!DOCTYPE html>
<html>
  <head>
    <title>Listagem Cargas Portaria</title>
    <%- include('System/headIncludes.ejs') %>
    <style>
      .top-actions { display:flex; justify-content:flex-end; align-items:center; margin-bottom:12px; }
      .custom-table td, .custom-table th { font-size:13px; }
      .dataTables_wrapper .dt-length { margin-right: 8px; }
      .dataTables_wrapper .dataTables_filter { margin: 0; }
      .dataTables_wrapper .dataTables_filter label { display:flex; align-items:center; gap:8px; margin:0; }
      .dataTables_wrapper .dt-buttons { display:flex; align-items:center; }
      .dataTables_wrapper .dt-buttons .dt-button, .dataTables_wrapper .dt-buttons .btn { margin-left:16px; margin-top:6px; }
      .status-concluida { background: #d4edda !important; color: #155724 !important; font-weight: bold; }
      .status-pendente { background: #fff3cd !important; color: #856404 !important; font-weight: bold; }
      .status-nao-concluida { background: #f8d7da !important; color: #721c24 !important; font-weight: bold; }
    </style>
  </head>
  <body>
    <div class="layout-container">
      <%- include('partials/sidebar') %>
      <div class="main-content">
        <div class="topbar">
          <div class="topbar-left">
            <div class="page-info">
              <h1>Cargas Portaria - Listagem</h1>
              <p>Registros já salvos em CARGAS_PORTARIA</p>
            </div>
          </div>
          <div class="topbar-right">
            <%- include('partials/userMenu') %>
          </div>
        </div>

        <div class="content p-3">
          <% 
            var platesSet = new Set();
            var driversSet = new Set();
            var usersSet = new Set();
            (cargas || []).forEach(function(r){ try{ if (r.placa && String(r.placa).trim()) platesSet.add(String(r.placa).trim()); if (r.motorista && String(r.motorista).trim()) driversSet.add(String(r.motorista).trim()); if (r.criado_por && String(r.criado_por).trim()) usersSet.add(String(r.criado_por).trim()); }catch(_){}});
            var platesCount = platesSet.size || 0;
            var driversCount = driversSet.size || 0;
            var usersCount = usersSet.size || 0;
          %>
          <div class="widgets-grid mb-4">
            <div class="widget clickable-widget" onclick="window.location.href='/listagem/cargas-portaria'" style="cursor:pointer;">
              <div class="widget-content"><h3><%= cargas ? cargas.length : 0 %></h3><p>Total de Registros</p></div>
              <div class="widget-icon primary"><i class="bi bi-list"></i></div>
            </div>
            <div class="widget clickable-widget" onclick="window.location.href='/listagem/cargas-portaria'" style="cursor:pointer;">
              <div class="widget-content"><h3><span id="platesCountList"><%= platesCount %></span></h3><p>Placas Distintas</p></div>
              <div class="widget-icon danger"><i class="bi bi-tags"></i></div>
            </div>
            <div class="widget clickable-widget" onclick="window.location.href='/listagem/cargas-portaria'" style="cursor:pointer;">
              <div class="widget-content"><h3><span id="driversCountList"><%= driversCount %></span></h3><p>Motoristas Distintos</p></div>
              <div class="widget-icon success"><i class="bi bi-people"></i></div>
            </div>
            <div class="widget clickable-widget" onclick="window.location.href='/listagem/cargas-portaria'" style="cursor:pointer;">
              <div class="widget-content"><h3><span id="usersCountList"><%= usersCount %></span></h3><p>Usuários (Criado Por)</p></div>
              <div class="widget-icon info"><i class="bi bi-person"></i></div>
            </div>
          </div>

          <div class="card">
            <div class="card-body">
              <table id="dataTable" class="table table-bordered custom-table" style="width:100%">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Filial</th>
                    <th>Carga</th>
                    <th>Data Entrega</th>
                    <th>Placa</th>
                    <th>Tipo Entrega</th>
                    <th>Motorista</th>
                    <th>Peso</th>
                    <th>Status</th>
                    <th>Telefone</th>
                    <th>CPF/CNPJ</th>
                    <th>Criado Por</th>
                    <th>Dt Criação</th>
                  </tr>
                </thead>
                <tbody>
                  <% if (cargas && cargas.length) { cargas.forEach(function(r){ %>
                    <% var _statusClass = ''; try { var _s = String(r.status||'').toLowerCase(); if (_s.indexOf('concl') !== -1) _statusClass = 'status-concluida'; else if (_s.indexOf('pend') !== -1) _statusClass = 'status-pendente'; else if (_s.indexOf('nao') !== -1 || _s.indexOf('não') !== -1) _statusClass = 'status-nao-concluida'; } catch(_) {} %>
                    <tr>
                      <td><%= r.id %></td>
                      <td><%= r.filial %></td>
                      <td><%= r.carga %></td>
                      <td class="datetime-cell" title="<%= r.dt_entrega %>"><%= r.dt_entrega %></td>
                      <td><%= r.placa %></td>
                      <td><%= r.tipo_entrega %></td>
                      <td><%= r.motorista %></td>
                      <td><%= r.peso %></td>
                      <td class="status-cell <%= _statusClass %>"><%= r.status %></td>
                      <td><%= r.telefone %></td>
                      <td><%= r.cpf_cnpj %></td>
                      <td><%= r.criado_por %></td>
                      <td class="datetime-cell" title="<%= r.dt_criacao %>"><%= r.dt_criacao %></td>
                    </tr>
                  <% }); } %>
                </tbody>
              </table>
            </div>
          </div>
          <div class="card mt-3 mb-4">
            <div class="card-header">Gráficos</div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <canvas id="chartStatus"></canvas>
                </div>
                <div class="col-md-6">
                  <canvas id="chartTipo"></canvas>
                </div>
              </div>
              <div class="row mt-3">
                <div class="col-12">
                  <canvas id="chartPorDia"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <%- include('System/bodyIncludes.ejs') %>
    <script>
      document.addEventListener('DOMContentLoaded', function(){
        try {
          if (window.$ && $.fn && $.fn.DataTable) {
            var dataTable = $('#dataTable').DataTable({ autoWidth:false, dom: "<'top'<'d-flex justify-content-between'<'dt-length'l><'d-flex justify-content-end align-items-center'<'dt-search'f><'dt-buttons ms-2'B>>>>rtip", buttons:[{ extend:'excelHtml5', text:'<i class="fas fa-file-excel"></i> Excel', className:'btn btn-success btn-sm' }], lengthMenu:[[5,10,25,-1],[5,10,25,'Todos']], pageLength:10 });
            try{ dataTable.on('draw', function(){ formatDatetimeCells('.datetime-cell'); }); }catch(_){ }
          }
        } catch(e){console.error(e);} 

        function formatDatetimeCells(selector){
          selector = selector || '.datetime-cell';
          document.querySelectorAll(selector).forEach(function(td){
            try{
              var raw = td.getAttribute('title')||td.textContent||'';
              var m = raw.match(/(\d{4})-(\d{2})-(\d{2})[T\s](\d{2}):(\d{2})/);
              if (m) td.textContent = m[3] + '/' + m[2] + '/' + m[1] + ' ' + m[4]+':'+m[5];
              else { var d = new Date(raw); if (!isNaN(d)) td.textContent = d.toLocaleString('pt-BR',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'}); }
              td.setAttribute('title',td.textContent);
            }catch(_){ }
          });
        }

        try { formatDatetimeCells('.datetime-cell'); } catch(_){ }
      });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
      (function(){
        const cargas = <%- JSON.stringify(cargas || []) %>;
        function safeStr(v){ return v==null ? '' : String(v); }
        const statusCounts = {};
        const tipoCounts = {};
        const dayCounts = {};

        cargas.forEach(function(r){
          const status = (safeStr(r.status) || 'Pendente');
          statusCounts[status] = (statusCounts[status] || 0) + 1;
          const tipo = (safeStr(r.tipo_entrega) || 'Outro');
          tipoCounts[tipo] = (tipoCounts[tipo] || 0) + 1;
          const dRaw = r.dt_criacao || r.dt_entrega || r.dtCriacao || r.dt_entrega;
          if (dRaw) {
            const d = new Date(dRaw);
            if (!isNaN(d)) {
              const key = d.getFullYear() + '-' + (d.getMonth()+1) + '-' + d.getDate();
              dayCounts[key] = (dayCounts[key] || 0) + 1;
            }
          }
        });

        const colors = ['#007bff','#28a745','#ffc107','#dc3545','#6f42c1','#17a2b8','#fd7e14','#20c997'];
        function createChart(id,type,labels,data,options){
          const el = document.getElementById(id);
          if (!el) return;
          new Chart(el, {
            type: type,
            data: {
              labels: labels,
              datasets: [{
                label: options && options.label || '',
                data: data,
                backgroundColor: options && options.backgroundColor || labels.map((_,i)=>colors[i%colors.length]),
                borderColor: options && options.borderColor || labels.map((_,i)=>colors[i%colors.length]),
                tension: 0.2
              }]
            },
            options: Object.assign({
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { position: 'bottom' } }
            }, options && options.options || {})
          });
        }

        const statusLabels = Object.keys(statusCounts);
        const statusData = statusLabels.map(l=>statusCounts[l]);
        const tipoLabels = Object.keys(tipoCounts);
        const tipoData = tipoLabels.map(l=>tipoCounts[l]);
        const dayKeys = Object.keys(dayCounts).sort(function(a,b){ return new Date(a) - new Date(b); });
        const dayLabels = dayKeys;
        const dayData = dayKeys.map(k=>dayCounts[k]);
        function setH(id,h){ const c = document.getElementById(id); if(c) c.style.height = h + 'px'; }
        setH('chartStatus', 240); setH('chartTipo', 240); setH('chartPorDia', 220);

        createChart('chartStatus','doughnut',statusLabels,statusData,{label:'Status'});
        createChart('chartTipo','bar',tipoLabels,tipoData,{label:'Por Tipo', options:{ scales:{ y: { beginAtZero:true } } }});
        createChart('chartPorDia','line',dayLabels,dayData,{label:'Por Dia', options:{ scales:{ y: { beginAtZero:true } } }});
      })();
    </script>
  </body>
</html>
