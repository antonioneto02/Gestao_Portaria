<!DOCTYPE html>
<html>
  <head>
    <title>Cargas Portaria</title>
    <%- include('System/headIncludes.ejs') %>
    <style>
      .top-actions { display:flex; justify-content:flex-end; align-items:center; margin-bottom:12px; }
      .custom-table td, .custom-table th { font-size:13px; }
      .dataTables_wrapper .dt-length { margin-right: 8px; }
      .dataTables_wrapper .dataTables_filter { margin: 0; }
      .dataTables_wrapper .dataTables_filter label { display:flex; align-items:center; gap:8px; margin:0; }
      .dataTables_wrapper .dt-buttons { display:flex; align-items:center; }
      .dataTables_wrapper .dt-buttons .dt-button, .dataTables_wrapper .dt-buttons .btn { margin-left:16px; margin-top:6px; }
      .status-concluida { background: #d4edda !important; color: #155724 !important; font-weight: bold; }
      .status-pendente { background: #fff3cd !important; color: #856404 !important; font-weight: bold; }
      .status-nao-concluida { background: #f8d7da !important; color: #721c24 !important; font-weight: bold; }
    </style>
  </head>
  <body>
    <div class="layout-container">
      <%- include('partials/sidebar') %>
      <div class="main-content">
        <div class="topbar">
          <div class="topbar-left">
              <div class="page-info">
              <h1>Cargas Portaria</h1>
              <p>Registros já salvos em CARGAS_PORTARIA</p>
            </div>
          </div>
          <div class="topbar-right">
            <%- include('partials/userMenu') %>
          </div>
        </div>

        <div class="content p-3">
          <% 
            var platesSet = new Set();
            var driversSet = new Set();
            var usersSet = new Set();
            (cargas || []).forEach(function(r){ try{ if (r.placa && String(r.placa).trim()) platesSet.add(String(r.placa).trim()); if (r.motorista && String(r.motorista).trim()) driversSet.add(String(r.motorista).trim()); if (r.criado_por && String(r.criado_por).trim()) usersSet.add(String(r.criado_por).trim()); }catch(_){}});
            var platesCount = platesSet.size || 0;
            var driversCount = driversSet.size || 0;
            var usersCount = usersSet.size || 0;
          %>
            <div class="widgets-grid mb-4">
            <div class="widget clickable-widget" onclick="window.location.href='/listagem/cargas-portaria'" style="cursor:pointer;">
              <div class="widget-content"><h3><%= cargas ? cargas.length : 0 %></h3><p>Total de Registros</p></div>
              <div class="widget-icon primary"><i class="bi bi-list"></i></div>
            </div>
            <div class="widget clickable-widget" onclick="window.location.href='/listagem/cargas-portaria'" style="cursor:pointer;">
              <div class="widget-content"><h3><span id="platesCountList"><%= platesCount %></span></h3><p>Placas Distintas</p></div>
              <div class="widget-icon danger"><i class="bi bi-tags"></i></div>
            </div>
            <div class="widget clickable-widget" onclick="window.location.href='/listagem/cargas-portaria'" style="cursor:pointer;">
              <div class="widget-content"><h3><span id="driversCountList"><%= driversCount %></span></h3><p>Motoristas Distintos</p></div>
              <div class="widget-icon success"><i class="bi bi-people"></i></div>
            </div>
            <div class="widget clickable-widget" onclick="window.location.href='/listagem/cargas-portaria'" style="cursor:pointer;">
              <div class="widget-content"><h3><span id="usersCountList"><%= usersCount %></span></h3><p>Usuários (Criado Por)</p></div>
              <div class="widget-icon info"><i class="bi bi-person"></i></div>
            </div>
          </div>

          

          <div class="card">
            <div class="card-body">
              <table id="dataTable" class="table table-bordered custom-table" style="width:100%">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Filial</th>
                    <th>Carga</th>
                    <th>Data Entrega</th>
                    <th>Placa</th>
                    <th>Tipo Entrega</th>
                    <th>Motorista</th>
                    <th>Peso</th>
                    <th>Status</th>
                    <th>Telefone</th>
                    <th>CPF/CNPJ</th>
                    <th>Criado Por</th>
                    <th>Dt Saída</th>
                    <th class="actions-col">Ações</th>
                  </tr>
                </thead>
                <tbody>
                  <% if (cargas && cargas.length) { cargas.forEach(function(r){ %>
                    <% var _statusClass = ''; try { var _s = String(r.status||'').toLowerCase(); if (_s.indexOf('concl') !== -1) _statusClass = 'status-concluida'; else if (_s.indexOf('pend') !== -1) _statusClass = 'status-pendente'; else if (_s.indexOf('nao') !== -1 || _s.indexOf('não') !== -1) _statusClass = 'status-nao-concluida'; } catch(_) {} %>
                    <tr>
                      <td class="cell-tooltip" title="<%= r.id %>"><%= r.id %></td>
                      <td class="cell-tooltip" title="<%= r.filial %>"><%= r.filial %></td>
                      <td class="cell-tooltip" title="<%= r.carga %>"><%= r.carga %></td>
                      <td class="cell-tooltip datetime-cell" title="<%= r.dt_entrega %>" data-dt="<%= r.dt_entrega %>"><%= r.dt_entrega %></td>
                      <td class="cell-tooltip" title="<%= r.placa %>"><%= r.placa %></td>
                      <td class="cell-tooltip" title="<%= r.tipo_entrega %>"><%= r.tipo_entrega %></td>
                      <td class="cell-tooltip" title="<%= r.motorista %>"><%= r.motorista %></td>
                      <td class="cell-tooltip" title="<%= r.peso %>"><%= r.peso %></td>
                      <td class="cell-tooltip status-cell <%= _statusClass %>" title="<%= r.status %>"><%= r.status %></td>
                      <td class="cell-tooltip" title="<%= r.telefone %>"><%= r.telefone %></td>
                      <td class="cell-tooltip" title="<%= r.cpf_cnpj %>"><%= r.cpf_cnpj %></td>
                      <td class="cell-tooltip" title="<%= r.criado_por %>"><%= r.criado_por %></td>
                          <td class="cell-tooltip datetime-cell" title="<%= r.dt_criacao %>" data-dt="<%= r.dt_criacao %>"><%= r.dt_criacao %></td>
                          <td class="actions-col text-center">
                            <button type="button" class="btn btn-danger btn-icon-sm btn-excluir-carga" data-id="<%= r.id %>" title="Excluir">
                              <i class="fas fa-trash"></i>
                            </button>
                          </td>
                    </tr>
                  <% }); } %>
                </tbody>
              </table>
            </div>
          </div>
          <div class="card mt-3 mb-4">
            <div class="card-header">Gráficos</div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <canvas id="chartStatus"></canvas>
                </div>
                <div class="col-md-6">
                  <canvas id="chartTipo"></canvas>
                </div>
              </div>
              <div class="row mt-3">
                <div class="col-12">
                  <canvas id="chartPorDia"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <%- include('System/bodyIncludes.ejs') %>
    <div class="modal fade" id="cadastroModal" tabindex="-1" aria-labelledby="cadastroModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="cadastroModalLabel">Cadastrar Saída por Placa</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body">
            <form id="cadastroForm">
              <div class="row">
                <div class="col-md-4 mb-2">
                  <label class="form-label">Placa</label>
                  <div class="position-relative">
                    <input id="cadastroPlaca" class="form-control" placeholder="Digite para buscar..." autocomplete="off" />
                    <ul id="placaDropdown" class="dropdown-menu w-100" style="max-height:180px;overflow-y:auto;position:absolute;top:100%;left:0;right:0;z-index:1050;display:none;width:100%;"></ul>
                    <input type="hidden" id="placaHidden" name="placa_selected">
                  </div>
                </div>
                <div class="col-md-4 mb-2">
                  <label class="form-label">Filial</label>
                  <input id="cadastroFilial" class="form-control" />
                </div>
                <div class="col-md-4 mb-2">
                  <label class="form-label">Carga</label>
                  <input id="cadastroCarga" class="form-control" />
                </div>
              </div>
              <div class="row">
                <div class="col-md-4 mb-2">
                  <label class="form-label">Data Entrega</label>
                  <input id="cadastroDtEntrega" type="datetime-local" class="form-control" />
                </div>
                <div class="col-md-4 mb-2">
                  <label class="form-label">Tipo Entrega</label>
                  <input id="cadastroTipoEntrega" class="form-control" />
                </div>
                <div class="col-md-4 mb-2">
                  <label class="form-label">Motorista</label>
                  <input id="cadastroMotorista" class="form-control" />
                </div>
              </div>
              <div class="row">
                <div class="col-md-4 mb-2">
                  <label class="form-label">Peso</label>
                  <input id="cadastroPeso" class="form-control" />
                </div>
                <div class="col-md-8 mb-2">
                  <label class="form-label">Registros encontrados</label>
                  <div id="matchesList" class="list-group" style="max-height:200px; overflow:auto;"></div>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" id="cadastroSaveBtn" class="btn btn-primary">Salvar</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="confirmDeleteModalLabel">Confirmar Exclusão</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body">
            <p id="confirmDeleteMessage">Tem certeza que deseja excluir este registro? Esta ação não pode ser desfeita.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" id="confirmDeleteBtn" class="btn btn-danger">Excluir</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      window.cargasData = <%- JSON.stringify(cargas || []) %>;
      (function(){
        function safe(v){ return v==null ? '' : String(v); }

        $(function(){

          function renderMatches(matches){
            var $list = $('#matchesList');
            $list.empty();
            if (!matches || !matches.length) { $list.append('<div class="text-muted p-2">Nenhum registro encontrado</div>'); return; }
            matches.forEach(function(m, i){
              var title = (safe(m.placa) || safe(m.PLACA)) + ' — ' + (safe(m.carga) || safe(m.CARGA)) + ' — ' + (safe(m.motorista) || safe(m.MOTORISTA));
              var $it = $('<button type="button" class="list-group-item list-group-item-action match-item" data-idx="'+i+'"></button>');
              $it.text(title);
              $it.data('rec', m);
              $list.append($it);
            });
          }

          function findMatchesByPlaca(q){
            if (!q) return [];
            q = String(q).trim().toLowerCase();
            return (window.cargasData || []).filter(function(r){ try { return String((r.placa||r.PLACA||'')).toLowerCase().indexOf(q) !== -1; } catch(e){ return false; } });
          }

          function populateFormWith(rec){
            if (!rec) return;
            $('#cadastroFilial').val(rec.filial || rec.FILIAL || '');
            $('#cadastroCarga').val(rec.carga || rec.CARGA || '');
            var raw = rec.dt_entrega || rec.DT_ENTREG || rec.DT_ENTREG_RAW || rec.dt_entrega;
            if (raw) {
              try {
                var d = new Date(raw);
                if (!isNaN(d)) {
                  var tzOffset = d.getTimezoneOffset() * 60000;
                  var localISO = new Date(d - tzOffset).toISOString().slice(0,19);
                  $('#cadastroDtEntrega').val(localISO);
                } else {
                  $('#cadastroDtEntrega').val('');
                }
              } catch(_) { $('#cadastroDtEntrega').val(''); }
            } else { $('#cadastroDtEntrega').val(''); }
            $('#cadastroPlaca').val(rec.placa || rec.PLACA || '');
            $('#cadastroTipoEntrega').val(rec.tipo_entrega || rec.TIPO_ENTREGA || '');
            $('#cadastroMotorista').val(rec.motorista || rec.MOTORISTA || '');
            $('#cadastroPeso').val(rec.peso || rec.PESO || '');
          }

          var placaInputEl = document.getElementById('cadastroPlaca');
          var placaDropdownEl = document.getElementById('placaDropdown');
          var placaHiddenEl = document.getElementById('placaHidden');
          var placas = [];
          (window.cargasData || []).forEach(function(r){
            try {
              var p = String(r.placa || r.PLACA || '').trim();
              if (!p) return;
              var found = placas.find(function(x){ return String(x.placa).toLowerCase() === p.toLowerCase(); });
              if (!found) placas.push({ placa: p, rec: r });
            } catch(_){}
          });

          function normalizeStrLocal(s) {
            try { return String(s || '').normalize('NFD').replace(/\p{Diacritic}/gu,'').replace(/\s+/g,' ').trim().toLowerCase(); } catch(e) { return String(s||'').toLowerCase(); }
          }
          function matchesPlate(name, filter) {
            if (!filter) return true;
            var normName = normalizeStrLocal(name || '');
            var tokens = normalizeStrLocal(filter).split(' ').filter(function(t){ return t; });
            return tokens.every(function(t){ return normName.indexOf(t) !== -1; });
          }
          function renderPlacaDropdown(filter){
            placaDropdownEl.innerHTML = '';
            var filtered = placas.filter(function(p){ return matchesPlate(p.placa || '', filter || ''); });
            if (!filtered.length) { placaDropdownEl.style.display = 'none'; return; }
            filtered.forEach(function(p){
              var li = document.createElement('li');
              li.className = 'dropdown-item';
              li.textContent = p.placa;
              li.setAttribute('data-placa', p.placa);
              li.style.cursor = 'pointer';
              li.onclick = function(){
                placaInputEl.value = p.placa;
                placaHiddenEl.value = JSON.stringify(p.rec);
                placaDropdownEl.style.display = 'none';
                populateFormWith(p.rec || {});
                var matches = (window.cargasData || []).filter(function(r){ try { return String((r.placa||r.PLACA||'')).toLowerCase() === String(p.placa).toLowerCase(); } catch(e){ return false; } });
                renderMatches(matches);
              };
              placaDropdownEl.appendChild(li);
            });
            placaDropdownEl.style.display = 'block';
          }

          $('#cadastroPlaca').on('input', function(){
            placaHiddenEl.value = '';
            var q = $(this).val();
            var matches = findMatchesByPlaca(q);
            renderMatches(matches);
            if (matches && matches.length) populateFormWith(matches[0]);
            try { renderPlacaDropdown(q); } catch(_){}
          });
        
            (function(){
              var placaInput = document.getElementById('cadastroPlaca');
              var placaDropdown = document.getElementById('placaDropdown');
              var placaHidden = document.getElementById('placaHidden');
              if (!placaInput || !placaDropdown || !placaHidden) return;
              var placas = [];
              (window.cargasData || []).forEach(function(r){
                try {
                  var p = String(r.placa || r.PLACA || '').trim();
                  if (!p) return;
                  var found = placas.find(function(x){ return String(x.placa).toLowerCase() === p.toLowerCase(); });
                  if (!found) placas.push({ placa: p, rec: r });
                } catch(_){}
              });

              function normalizeStr(s) {
                try {
                  return String(s || '')
                    .normalize('NFD')
                    .replace(/\p{Diacritic}/gu, '')
                    .replace(/\s+/g, ' ')
                    .trim()
                    .toLowerCase();
                } catch (e) {
                  return String(s || '').toLowerCase();
                }
              }

              function matchesPlaca(name, filter) {
                if (!filter) return true;
                var normName = normalizeStr(name || '');
                var tokens = normalizeStr(filter).split(' ').filter(function(t){ return t; });
                return tokens.every(function(t){ return normName.indexOf(t) !== -1; });
              }

              function renderPlacaDropdown(filter) {
                placaDropdown.innerHTML = '';
                var filtered = placas.filter(function(p){ return matchesPlaca(p.placa || '', filter || ''); });
                if (!filtered.length) { placaDropdown.style.display = 'none'; return; }
                filtered.forEach(function(p){
                  var li = document.createElement('li');
                  li.className = 'dropdown-item';
                  li.textContent = p.placa;
                  li.setAttribute('data-placa', p.placa);
                  li.style.cursor = 'pointer';
                  li.onclick = function(){
                    placaInput.value = p.placa;
                    placaHidden.value = JSON.stringify(p.rec);
                    placaDropdown.style.display = 'none';
                    populateFormWith(p.rec || {});
                    var matches = (window.cargasData || []).filter(function(r){ try { return String((r.placa||r.PLACA||'')).toLowerCase() === String(p.placa).toLowerCase(); } catch(e){ return false; } });
                    renderMatches(matches);
                  };
                  placaDropdown.appendChild(li);
                });
                placaDropdown.style.display = 'block';
              }

              placaInput.addEventListener('input', function(){
                placaHidden.value = '';
                renderPlacaDropdown(placaInput.value);
              });
              placaInput.addEventListener('focus', function(){ renderPlacaDropdown(placaInput.value); });
              placaInput.addEventListener('blur', function(){ setTimeout(function(){ placaDropdown.style.display = 'none'; }, 200); });
            })();

          if (placaInputEl && placaDropdownEl) {
            placaInputEl.addEventListener('focus', function(){ renderPlacaDropdown(placaInputEl.value); });
            placaInputEl.addEventListener('blur', function(){ setTimeout(function(){ placaDropdownEl.style.display = 'none'; }, 200); });
          }

          $(document).on('click', '.match-item', function(){
            var rec = $(this).data('rec');
            populateFormWith(rec);
          });

          function parseResponseJsonSafe(response){
            var ct = (response && response.headers && response.headers.get('content-type')) ? response.headers.get('content-type') : '';
            if (!response.ok) {
              return response.text().then(function(t){ throw new Error(t || ('HTTP ' + response.status)); });
            }
            if (ct && ct.indexOf('application/json') !== -1) return response.json();
            return response.text().then(function(t){ try { return JSON.parse(t); } catch(e){ return { success: false, message: t || 'Resposta inesperada' }; } });
          }

          $('#cadastroSaveBtn').on('click', function(e){
            e.preventDefault();
            var payload = {
              filial: $('#cadastroFilial').val() || null,
              carga: $('#cadastroCarga').val() || null,
              dt_entrega: $('#cadastroDtEntrega').val() || null,
              placa: $('#cadastroPlaca').val() || null,
              tipo_entrega: $('#cadastroTipoEntrega').val() || null,
              motorista: $('#cadastroMotorista').val() || null,
              peso: $('#cadastroPeso').val() || null
            };
            fetch('/cargas-portaria/concluir', {
              method: 'POST',
              credentials: 'same-origin',
              headers: { 'Content-Type':'application/json' },
              body: JSON.stringify(payload)
            }).then(parseResponseJsonSafe).then(function(json){
              if (json && json.success) {
                try { $('#cadastroModal').modal('hide'); } catch(_){}
                location.reload();
              } else {
                alert('Erro ao salvar: ' + (json && json.message ? json.message : 'erro desconhecido'));
              }
            }).catch(function(err){ console.error(err); alert('Erro ao salvar: ' + (err && err.message ? err.message : 'erro desconhecido')); });
          });

          (function(){
            var deleteTargetId = null;
            var bsConfirmModal = null;
            $(document).on('click', '.btn-excluir-carga', function(){
              var id = $(this).data('id');
              if (!id) return;
              deleteTargetId = id;
              $('#confirmDeleteMessage').text('Confirma exclusão do registro ID ' + id + '? Esta ação é irreversível.');
              var el = document.getElementById('confirmDeleteModal');
              try { bsConfirmModal = new bootstrap.Modal(el); bsConfirmModal.show(); } catch(e){ $('#confirmDeleteModal').modal('show'); }
            });

            $('#confirmDeleteBtn').on('click', function(){
              var id = deleteTargetId;
              if (!id) return;
              var $btn = $(this);
              $btn.prop('disabled', true).text('Excluindo...');
              fetch('/cargas-portaria/delete', {
                method: 'POST',
                credentials: 'same-origin',
                headers: { 'Content-Type':'application/json' },
                body: JSON.stringify({ id: id })
              }).then(parseResponseJsonSafe).then(function(json){
                if (json && json.success) {
                  try { if (bsConfirmModal) bsConfirmModal.hide(); else $('#confirmDeleteModal').modal('hide'); } catch(_){ $('#confirmDeleteModal').modal('hide'); }
                  location.reload();
                } else {
                  alert('Erro ao excluir: ' + (json && json.message ? json.message : 'erro desconhecido'));
                }
              }).catch(function(err){ console.error(err); alert('Erro ao excluir: ' + (err && err.message ? err.message : 'erro desconhecido')); }).finally(function(){ $btn.prop('disabled', false).text('Excluir'); });
            });
          })();
        });
      })();
    </script>
    <script>
      document.addEventListener('DOMContentLoaded', function(){
        try {
          if (window.$ && $.fn && $.fn.DataTable) {
            var dataTable = $('#dataTable').DataTable({ autoWidth:false, dom: "<'top'<'d-flex justify-content-between'<'dt-length'l><'d-flex justify-content-end align-items-center'<'dt-search'f><'dt-buttons ms-2'B>>>>rtip", buttons:[{ extend:'excelHtml5', text:'<i class="fas fa-file-excel"></i> Excel', className:'btn btn-success btn-sm' }], lengthMenu:[[5,10,25,-1],[5,10,25,'Todos']], pageLength:10 });
            try{ dataTable.on('draw', function(){ formatDatetimeCells('.datetime-cell'); }); }catch(_){ }
            try {
              try { createColumnFilter('#dataTable','Carga'); } catch(_){}
              try { createColumnFilter('#dataTable','Placa'); } catch(_){}
              try { createColumnFilter('#dataTable','Motorista'); } catch(_){}
              try { createColumnFilter('#dataTable','Status'); } catch(_){}
              try{
                var $cf = $('#dataTable').prev('.column-filters');
                if ($cf && $cf.length) {
                  $cf.css({ 'overflow-x': 'hidden', 'flex-wrap': 'nowrap', 'gap': '6px' });
                  $cf.find('input').css({ 'min-width': '120px', 'width': 'auto', 'flex': '0 0 auto' });
                }
              }catch(_){ }
            } catch(_){ }
          }
        } catch(e){console.error(e);} 

        function formatDatetimeCells(selector){
          selector = selector || '.datetime-cell';
          document.querySelectorAll(selector).forEach(function(td){
            try{
              var raw = td.getAttribute('title')||td.textContent||'';
              var m = raw.match(/(\d{4})-(\d{2})-(\d{2})[T\s](\d{2}):(\d{2})/);
              if (m) td.textContent = m[3] + '/' + m[2] + '/' + m[1] + ' ' + m[4]+':'+m[5];
              else { var d = new Date(raw); if (!isNaN(d)) td.textContent = d.toLocaleString('pt-BR',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'}); }
              td.setAttribute('title',td.textContent);
            }catch(_){ }
          });
        }

        try { formatDatetimeCells('.datetime-cell'); } catch(_){ }
      });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
      (function(){
        const cargas = <%- JSON.stringify(cargas || []) %>;
        function safeStr(v){ return v==null ? '' : String(v); }
        const statusCounts = {};
        const tipoCounts = {};
        const dayCounts = {};

        cargas.forEach(function(r){
          const status = (safeStr(r.status) || 'Pendente');
          statusCounts[status] = (statusCounts[status] || 0) + 1;
          const tipo = (safeStr(r.tipo_entrega) || 'Outro');
          tipoCounts[tipo] = (tipoCounts[tipo] || 0) + 1;
          const dRaw = r.dt_criacao || r.dt_entrega || r.dtCriacao || r.dt_entrega;
          if (dRaw) {
            const d = new Date(dRaw);
            if (!isNaN(d)) {
              const key = d.getFullYear() + '-' + (d.getMonth()+1) + '-' + d.getDate();
              dayCounts[key] = (dayCounts[key] || 0) + 1;
            }
          }
        });

        const colors = ['#007bff','#28a745','#ffc107','#dc3545','#6f42c1','#17a2b8','#fd7e14','#20c997'];
        function createChart(id,type,labels,data,options){
          const el = document.getElementById(id);
          if (!el) return;
          new Chart(el, {
            type: type,
            data: {
              labels: labels,
              datasets: [{
                label: options && options.label || '',
                data: data,
                backgroundColor: options && options.backgroundColor || labels.map((_,i)=>colors[i%colors.length]),
                borderColor: options && options.borderColor || labels.map((_,i)=>colors[i%colors.length]),
                tension: 0.2
              }]
            },
            options: Object.assign({
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { position: 'bottom' } }
            }, options && options.options || {})
          });
        }

        const statusLabels = Object.keys(statusCounts);
        const statusData = statusLabels.map(l=>statusCounts[l]);
        const tipoLabels = Object.keys(tipoCounts);
        const tipoData = tipoLabels.map(l=>tipoCounts[l]);
        const dayKeys = Object.keys(dayCounts).sort(function(a,b){ return new Date(a) - new Date(b); });
        const dayLabels = dayKeys;
        const dayData = dayKeys.map(k=>dayCounts[k]);
        function setH(id,h){ const c = document.getElementById(id); if(c) c.style.height = h + 'px'; }
        setH('chartStatus', 240); setH('chartTipo', 240); setH('chartPorDia', 220);

        createChart('chartStatus','doughnut',statusLabels,statusData,{label:'Status'});
        createChart('chartTipo','bar',tipoLabels,tipoData,{label:'Por Tipo', options:{ scales:{ y: { beginAtZero:true } } }});
        createChart('chartPorDia','line',dayLabels,dayData,{label:'Por Dia', options:{ scales:{ y: { beginAtZero:true } } }});
      })();
    </script>
      <script>
        (function(){
          try {
            var params = new URLSearchParams(window.location.search || '');
            if (params.get('openCadastro') === '1') {
              if (window.$ && $.fn && $.fn.modal) {
                $('#cadastroModal').modal('show');
              } else {
                var el = document.getElementById('cadastroModal');
                if (el) try { new bootstrap.Modal(el).show(); } catch(e){}
              }
              if (history && history.replaceState) {
                var url = new URL(window.location.href);
                url.searchParams.delete('openCadastro');
                history.replaceState(null, '', url.toString());
              }
            }
          } catch(e){}
        })();
      </script>
  </body>
</html>
