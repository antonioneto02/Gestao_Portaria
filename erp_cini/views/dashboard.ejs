<!DOCTYPE html>
<html lang="pt-br">
<head>
  <%- include('System/headIncludes.ejs') %>
  <title>Dashboard | ERP CINI</title>
  <style>
    .btn-icon-sm {
      padding: 0 !important;
      font-size: 0.55rem !important;
      line-height: 1 !important;
      border-radius: 0.15rem !important;
      display: inline-flex !important;
      align-items: center;
      justify-content: center;
        width: 32px !important;
        height: 16px !important;
        min-width: 32px !important;
        min-height: 16px !important;
      border-width: 1px !important;
    }
      .btn-icon-sm {
        border-radius: 4px !important;
      }
    .btn-icon-sm i { margin: 0; font-size: 0.7rem !important; }
    .btn-icon-sm:focus,
    .btn-icon-sm:hover {
      box-shadow: none !important;
    }
  </style>
</head>
<body>
  <div class="layout-container">
    <%- include('partials/sidebar') %>
    <div class="main-content">
      <div class="topbar">
        <div class="topbar-left">
          <div class="page-info">
            <h1>Dashboard</h1>
            <p>Bem-vindo ao seu painel de controle</p>
          </div>
        </div>
        <div class="topbar-right">
          <%- include('partials/userMenu') %>
        </div>
      </div>

      <div class="content">
        <% var agendamentosAtrasados = (typeof agendamentosAtrasados !== 'undefined' && agendamentosAtrasados) ? agendamentosAtrasados : []; %>
        <div class="widgets-grid">

          <div class="widget clickable-widget" onclick="window.location.href='/agendamentos'" style="cursor:pointer;">
            <div class="widget-content"><h3><%= typeof total_agendamentos !== 'undefined' ? total_agendamentos : total_plans %></h3><p>Agendamentos</p></div>
            <div class="widget-icon primary"><i class="bi bi-calendar-check"></i></div>
          </div>

          <div class="widget clickable-widget" onclick="window.location.href='/agendamentos'" style="cursor:pointer;">
            <div class="widget-content"><h3><%= typeof count_visita !== 'undefined' ? count_visita : total_tasks %></h3><p>Visitas</p></div>
            <div class="widget-icon info"><i class="bi bi-person-lines-fill"></i></div>
          </div>

          <div class="widget clickable-widget" onclick="window.location.href='/agendamentos'" style="cursor:pointer;">
            <div class="widget-content"><h3><%= typeof count_prest_servicos !== 'undefined' ? count_prest_servicos : completed_tasks %></h3><p>Prestação de Serviços</p></div>
            <div class="widget-icon success"><i class="bi bi-gear-wide-connected"></i></div>
          </div>

          <div class="widget clickable-widget" onclick="window.location.href='/agendamentos'" style="cursor:pointer;">
            <div class="widget-content">
              <h3><%= (agendamentosAtrasados && agendamentosAtrasados.length) ? agendamentosAtrasados.length : 0 %></h3>
              <p>Atrasadas</p>
            </div>
            <div class="widget-icon danger"><i class="bi bi-exclamation-triangle"></i></div>
          </div>
        </div>
        <div class="card mt-20">
          <div class="card-header">Agendamentos de Hoje</div>
          <div class="card-body">
            <table id="agendamentosHojeTable" class="table table-bordered custom-table" style="width:100%">
              <thead>
                <tr>
                  <% if (agendamentosHoje && agendamentosHoje.length) {
                       let keys = Object.keys(agendamentosHoje[0]);
                       keys = keys.filter(k => String(k || '').toLowerCase().replace(/[^a-z0-9]/g,'') !== 'concluidopor');
                       const preferred = ['id','data_hora','dataHora','DataHora','tipo','assunto','nome','responsavel','telefone','cpf_cnpj','status','criado_por','dt_criacao'];
                       const ordered = [];
                       preferred.forEach(k=>{ if (keys.indexOf(k)!==-1 && ordered.indexOf(k)===-1) ordered.push(k); });
                       keys.forEach(k=>{ if (ordered.indexOf(k)===-1) ordered.push(k); });
                       for(let i=0;i<ordered.length;i++){ const k = ordered[i]; %>
                    <th><%= k.replace(/_/g,' ').replace(/\b\w/g, l=>l.toUpperCase()) %></th>
                  <% } %>
                  <th>Ações</th>
                  <% } else { %>
                    <th>ID</th>
                    <th>Data / Hora</th>
                    <th>Tipo</th>
                    <th>Assunto</th>
                    <th>Nome</th>
                    <th>Responsável</th>
                    <th>Telefone</th>
                    <th>CPF/CNPJ</th>
                    <th>Status</th>
                    <th>Ações</th>
                  <% } %>
                </tr>
              </thead>
              <tbody>
                <% if (agendamentosHoje && agendamentosHoje.length) {
                     let keys = Object.keys(agendamentosHoje[0]);
                     keys = keys.filter(k => String(k || '').toLowerCase().replace(/[^a-z0-9]/g,'') !== 'concluidopor');
                     const preferred = ['id','data_hora','dataHora','DataHora','tipo','assunto','nome','responsavel','telefone','cpf_cnpj','status','criado_por','dt_criacao'];
                     const ordered = [];
                     preferred.forEach(k=>{ if (keys.indexOf(k)!==-1 && ordered.indexOf(k)===-1) ordered.push(k); });
                     keys.forEach(k=>{ if (ordered.indexOf(k)===-1) ordered.push(k); });
                     agendamentosHoje.forEach(function(a){
                       var st = (a.status || '').toString().toLowerCase();
                       if (st === 'pendente') {
                     %>
                  <tr>
                    <% ordered.forEach(function(col){ let raw = a[col]; let display = raw; if (col) { const low = col.toLowerCase(); if (col === 'tipo') { try { var alt = a['tipo_outro'] || a.tipo_outro; if (alt && String(alt).trim()) { display = alt; } } catch(_){} } if (low.indexOf('dt_criacao') !== -1 || low.indexOf('dt criação') !== -1) { try { if (typeof raw === 'string') { const m = raw.match(/(\d{4})-(\d{2})-(\d{2})[T\s](\d{2}):(\d{2})/); if (m) { display = m[3] + '/' + m[2] + '/' + m[1] + ' ' + m[4] + ':' + m[5]; } else { const d = new Date(raw); if (!isNaN(d)) display = d.toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }); } } } catch(_){ } } else if (low === 'data_hora' || low.includes('data') || low.includes('hora')) { try { const d = new Date(raw); if (!isNaN(d)) display = d.toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }); } catch(_){ } } } %>
                      <td class="cell-tooltip <%= (col && (col.toLowerCase()==='data_hora' || col.toLowerCase().includes('data') || col.toLowerCase().includes('hora') || col.toLowerCase().indexOf('dt_criacao')!==-1)) ? 'datetime-cell-hoje':'' %>" title="<%= display %>" data-dt="<%= raw %>"><%= display %></td>
                    <% }) %>
                      <td>
                        <% const idVal = a.id || a.ID || a.Id || a.ID_AGENDAMENTO || a.IDAGENDA || '';
                           const st = (a.status || '').toString().toLowerCase(); %>
                        <% if (st === 'pendente') { %>
                          <button type="button" class="btn btn-success btn-icon-sm concluirBtn" data-id="<%= idVal %>" title="Concluir">
                            <i class="fas fa-check"></i>
                          </button>
                        <% } %>
                      </td>
                  </tr>
                <% }}); } %>
              </tbody>
            </table>
          </div>
        </div>

        <div class="grid grid-2 mt-20">
          <div class="card">
            <div class="card-header">Progresso Geral dos Agendamentos de Hoje</div>
            <div class="card-body">
              <div style="margin-bottom:16px;">
                <% 
                  var totalHoje = typeof agendamentosHoje !== 'undefined' ? agendamentosHoje.length : 0;
                  var concluidosHoje = 0;
                  if (typeof agendamentosHoje !== 'undefined' && agendamentosHoje.length) {
                    concluidosHoje = agendamentosHoje.filter(function(a){
                      var st = (a.status || '').toString().toLowerCase();
                      return st.indexOf('conclu') !== -1;
                    }).length;
                    var naoConcluidosHoje = agendamentosHoje.filter(function(a){
                      var st = (a.status || '').toString().toLowerCase();
                      return st.indexOf('não') !== -1 || st.indexOf('nao') !== -1 || st.indexOf('nao conclu') !== -1;
                    }).length;
                    var pendentesHoje = totalHoje - concluidosHoje - naoConcluidosHoje;
                  } else {
                    var naoConcluidosHoje = 0;
                    var pendentesHoje = totalHoje - concluidosHoje;
                  }
                  var progressoHoje = totalHoje > 0 ? Math.round((concluidosHoje / totalHoje) * 100) : 0;
                %>
                <div class="flex-between mb-10"><span style="font-size:13px;">Conclusão de Agendamentos do Dia</span><span style="font-size:13px;font-weight:600;"><%= progressoHoje %>%</span></div>
                <div style="height:8px;background:var(--gray);border-radius:4px;overflow:hidden;">
                  <div style="height:100%;background:var(--primary);width:<%= progressoHoje %>%;transition:all 0.3s ease;"></div>
                </div>
              </div>
              <table style="width:100%;font-size:13px;margin-top:16px;">
                <tr><td style="padding:8px 0;border-bottom:1px solid var(--gray);">Concluídos</td><td style="padding:8px 0;border-bottom:1px solid var(--gray);text-align:right;font-weight:600;"><%= concluidosHoje %></td></tr>
                <tr><td style="padding:8px 0;border-bottom:1px solid var(--gray);">Pendentes</td><td style="padding:8px 0;border-bottom:1px solid var(--gray);text-align:right;font-weight:600;"><%= Math.max(0, pendentesHoje) %></td></tr>
                <tr><td style="padding:8px 0;border-bottom:1px solid var(--gray);">Não Concluídos</td><td style="padding:8px 0;border-bottom:1px solid var(--gray);text-align:right;font-weight:600;"><%= naoConcluidosHoje %></td></tr>
                <tr><td style="padding:8px 0;">Total do Dia</td><td style="padding:8px 0;text-align:right;font-weight:600;"><%= totalHoje %></td></tr>
              </table>
            </div>
          </div>
        </div>
        </div>
      </div>
    </main>
  </div>
  <%- include('System/bodyIncludes.ejs') %>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const userName = document.getElementById('userName');
      if (userName) {
        const name = '<%= user && user.nome ? user.nome : "Usuário" %>';
        const initial = name.charAt(0).toUpperCase();
        document.getElementById('userInitials').textContent = initial;
        userName.textContent = name;
      }

      function formatDatetimeCells(selector){
        selector = selector || '.datetime-cell-hoje';
        document.querySelectorAll(selector).forEach(function(td){
          try{
            var raw = td.getAttribute('data-dt') || td.getAttribute('title') || td.textContent || '';
            var formatted = raw;
            if (typeof raw === 'string'){
              var m = raw.match(/(\d{4})-(\d{2})-(\d{2})[T\s](\d{2}):(\d{2})/);
              if (m) formatted = m[3] + '/' + m[2] + '/' + m[1] + ' ' + m[4] + ':' + m[5];
              else { var d = new Date(raw); if (!isNaN(d)) formatted = d.toLocaleString('pt-BR', { day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' }); }
            }
            td.textContent = formatted;
            td.setAttribute('title', formatted);
          }catch(_){ }
        });
      }

      function maskPhoneInput(e) {
        var el = e.target;
        var v = (el.value || '').replace(/\D/g, '');
        if (v.length > 11) v = v.slice(0,11);
        if (v.length > 10) {
          el.value = '(' + v.slice(0,2) + ') ' + v.slice(2,7) + '-' + v.slice(7);
        } else if (v.length > 6) {
          el.value = '(' + v.slice(0,2) + ') ' + v.slice(2,6) + '-' + v.slice(6);
        } else if (v.length > 2) {
          el.value = '(' + v.slice(0,2) + ') ' + v.slice(2);
        } else {
          el.value = v;
        }
      }

      function maskCpfCnpjInput(e) {
        var el = e.target;
        var v = (el.value || '').replace(/\D/g, '');
        if (v.length <= 11) {
          if (v.length > 11) v = v.slice(0,11);
          v = v.replace(/(\d{3})(\d)/, "$1.$2");
          v = v.replace(/(\d{3})\.(\d{3})(\d)/, "$1.$2.$3");
          v = v.replace(/(\d{3})\.(\d{3})\.(\d{3})(\d)/, "$1.$2.$3-$4");
          el.value = v;
        } else {
          v = v.slice(0,14);
          v = v.replace(/(\d{2})(\d)/, "$1.$2");
          v = v.replace(/(\d{2})\.(\d{3})(\d)/, "$1.$2.$3");
          v = v.replace(/(\d{2})\.(\d{3})\.(\d{3})(\d)/, "$1.$2.$3/$4");
          v = v.replace(/(\d{2})\.(\d{3})\.(\d{3})\/(\d{4})(\d)/, "$1.$2.$3/$4-$5");
          el.value = v;
        }
      }

      try {
        var telModal = document.getElementById('concluirTelefone');
        var cpfModal = document.getElementById('concluirCpfCnpj');
        if (telModal) {
          telModal.addEventListener('input', maskPhoneInput);
          telModal.addEventListener('paste', function(e){ setTimeout(function(){ maskPhoneInput({target: telModal}); }, 0); });
        }
        if (cpfModal) {
          cpfModal.addEventListener('input', maskCpfCnpjInput);
          cpfModal.addEventListener('paste', function(e){ setTimeout(function(){ maskCpfCnpjInput({target: cpfModal}); }, 0); });
        }
      } catch(_){ }

      try {
        if (window.$ && $.fn && $.fn.DataTable) {
          var todayTable = $('#agendamentosHojeTable').DataTable({
            autoWidth: false,
            dom: "<'top'<'d-flex justify-content-between'<'dt-length'l><'d-flex justify-content-end align-items-center'<'dt-search'f><'dt-buttons ms-2'B>>>>rtip",
            buttons: [
              {
                extend: 'excelHtml5',
                text: '<i class="fas fa-file-excel"></i> Excel',
                titleAttr: 'Exportar para Excel',
                className: 'btn btn-success btn-sm'
              }
            ],
            lengthMenu: [[5, 10, 25, -1], [5, 10, 25, 'Todos']],
            pageLength: 5,
            language: {
              decimal: ",",
              thousands: ".",
              emptyTable: "Nenhum registro encontrado",
              info: "Mostrando _START_ a _END_ de _TOTAL_ registros",
              infoEmpty: "Mostrando 0 a 0 de 0 registros",
              infoFiltered: "(filtrado de _MAX_ registros)",
              lengthMenu: "Mostrar _MENU_ registros",
              loadingRecords: "Carregando...",
              processing: "Processando...",
              search: "Pesquisar:",
              zeroRecords: "Nenhum registro encontrado",
              paginate: { first: "Primeiro", last: "Último", next: "Próximo", previous: "Anterior" }
            }
          });
          try{ if (todayTable && todayTable.on) todayTable.on('draw', function(){ formatDatetimeCells('.datetime-cell-hoje'); }); } catch(_){ }
          try {
            try { createColumnFilter('#agendamentosHojeTable','Tipo'); } catch(_){}
            try { createColumnFilter('#agendamentosHojeTable','Nome'); } catch(_){}
            try { createColumnFilter('#agendamentosHojeTable','Status'); } catch(_){}
            try{
              var $cf = $('#agendamentosHojeTable').prev('.column-filters');
              if ($cf && $cf.length) {
                $cf.css({ 'overflow-x': 'hidden', 'flex-wrap': 'nowrap', 'gap': '6px' });
                $cf.find('input').css({ 'min-width': '120px', 'width': 'auto', 'flex': '0 0 auto' });
              }
            }catch(_){ }
          } catch(_){ }
        }
      } catch(e) { console.error('DataTable init error:', e); }
      try { formatDatetimeCells('.datetime-cell-hoje'); } catch(_){ }
    });
  </script>
  <div class="modal fade" id="modalConcluir" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirmar Conclusão</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Tem certeza que deseja marcar este agendamento como concluído?</p>
          <div class="row g-2 mt-2">
            <div class="col-md-6">
              <label class="form-label">Telefone</label>
              <input type="text" id="concluirTelefone" class="form-control" placeholder="(00) 90000-0000">
            </div>
            <div class="col-md-6">
              <label class="form-label">CPF / CNPJ</label>
              <input type="text" id="concluirCpfCnpj" class="form-control" placeholder="CPF ou CNPJ">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Não</button>
          <button type="button" id="confirmConcluir" class="btn btn-primary">Sim, concluir</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function(){
      var selectedId = null;
      var modalEl = document.getElementById('modalConcluir');
      var bsModal = modalEl ? new bootstrap.Modal(modalEl) : null;
      var table = document.getElementById('agendamentosHojeTable');
      if (table) {
        table.addEventListener('click', function(e){
          var btn = e.target.closest('.concluirBtn');
          if (!btn) return;
          selectedId = btn.getAttribute('data-id');
          if (bsModal) bsModal.show();
        });
      }

      var confirmBtn = document.getElementById('confirmConcluir');
      if (confirmBtn) confirmBtn.addEventListener('click', function(){
        if (!selectedId) return;
        var telEl = document.getElementById('concluirTelefone');
        var cpfEl = document.getElementById('concluirCpfCnpj');
        function strip(v){ return String(v||'').replace(/\D+/g,''); }
        var telefone = telEl ? strip(telEl.value) : null;
        var cpf_cnpj = cpfEl ? strip(cpfEl.value) : null;
        fetch('/agendamentos/' + encodeURIComponent(selectedId) + '/concluir', { method: 'POST', credentials: 'same-origin', headers: { 'Content-Type':'application/json' }, body: JSON.stringify({ telefone: telefone, cpf_cnpj: cpf_cnpj }) })
          .then(function(r){ return r.json(); })
          .then(function(resp){
            if (resp && resp.success) {
              var btn = document.querySelector('.concluirBtn[data-id="' + selectedId + '"]');
              if (btn) {
                var tr = btn.closest('tr'); if (tr) tr.remove();
              }
              if (bsModal) bsModal.hide();
              window.location.reload(); 
            } else {
              alert('Erro ao atualizar status');
            }
          }).catch(function(err){ console.error(err); alert('Erro ao atualizar status'); });
      });
    })();
  </script>
</body>
</html>
